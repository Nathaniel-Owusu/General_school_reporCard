<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Report Card | General School</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Times+New+Roman&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background: #d1d5db;
            font-family: 'Times New Roman', Times, serif;
            min-height: 100vh;
            padding: 24px 16px;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        /* ─── Top Controls ─── */
        .top-bar {
            max-width: 210mm;
            margin: 0 auto 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .top-bar a, .top-bar button {
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            background: none;
            color: #1e3a8a;
            text-decoration: none;
        }
        .top-bar button { color: #dc2626; }

        /* ─── Print Button ─── */
        .print-btn-wrap {
            max-width: 210mm;
            margin: 18px auto 0;
            text-align: center;
        }
        .print-btn {
            font-family: 'Roboto', sans-serif;
            background: #1e3a8a;
            color: #fff;
            border: none;
            padding: 12px 36px;
            border-radius: 40px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 18px rgba(30,58,138,.35);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background .2s;
        }
        .print-btn:hover { background: #1e40af; }

        /* ─── Report Sheet ─── */
        #report-card {
            max-width: 210mm;
            margin: 0 auto;
        }

        .report-sheet {
            background: #fff;
            width: 100%;
            border: 1px solid #111;
            padding: 4px;
            min-height: 297mm;
            position: relative;
        }
        
        .report-sheet-inner {
            border: 3px solid #111;
            padding: 20px 24px;
            height: 100%;
            min-height: calc(297mm - 10px);
            position: relative;
        }

        /* ─── Watermark ─── */
        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 55%;
            opacity: 0.1;
            pointer-events: none;
            z-index: 0;
        }
        .watermark img { width: 100%; height: auto; }

        .report-sheet-inner > *:not(.watermark) { position: relative; z-index: 1; }

        /* ─── Header ─── */
        .report-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        .header-logo, .header-logo-placeholder {
            width: 90px;
            height: 90px;
            flex-shrink: 0;
            object-fit: contain;
        }
        .header-logo-placeholder {
            border: 1.5px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: #aaa;
        }
        .header-center {
            flex: 1;
            text-align: center;
            padding: 0 10px;
        }
        .header-center .school-authority {
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .header-center .school-name {
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            margin: 4px 0;
        }
        .header-center .school-address {
            font-size: 13px;
            color: #222;
        }
        .header-center .school-address a { color: #1e40af; text-decoration: none; }
        .passport-box {
            width: 90px;
            height: 110px;
            flex-shrink: 0;
            border: 1.5px solid #111;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            color: #111;
        }
        .passport-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ─── Title Bar ─── */
        .title-bar {
            background: #000;
            color: #fff;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
            text-transform: uppercase;
            padding: 6px 0;
            margin: 12px 0 16px;
            border: 1px solid #000;
            letter-spacing: 0.05em;
        }
        
        /* ─── Info Lines ─── */
        .info-row {
            display: flex;
            align-items: flex-end;
            margin-bottom: 12px;
            flex-wrap: nowrap;
        }
        .info-label {
            font-weight: bold;
            font-size: 13px;
            text-transform: uppercase;
            margin-right: 4px;
            white-space: nowrap;
        }
        .dotted-line {
            flex: 1;
            border-bottom: 1.5px dotted #111;
            min-width: 50px;
            margin-right: 12px;
            display: inline-flex;
            align-items: flex-end;
            color: #333;
            font-size: 14px;
            padding: 0 4px;
            white-space: nowrap;
            overflow: hidden;
            height: 18px;
        }
        .dotted-line:last-child { margin-right: 0; }

        /* ─── Subjects Table ─── */
        .subjects-table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            font-size: 14px;
        }
        .subjects-table th, .subjects-table td {
            border: 1.5px solid #000;
            padding: 6px;
            text-align: center;
            vertical-align: middle;
        }
        .subjects-table th {
            font-weight: bold;
            font-size: 13px;
            background: #eee;
        }
        .subjects-table td.subject-name {
            text-align: left;
            font-weight: normal;
            background: #fff;
        }
        .subjects-table .col-subject { width: 28%; }
        
        .empty-row td { height: 26px; }

        /* ─── Bottom Sections ─── */
        .bottom-line-row {
            display: flex;
            align-items: flex-end;
            margin-bottom: 12px;
            flex-wrap: nowrap;
        }
        .bl-label {
            font-weight: bold;
            font-size: 13px;
            text-transform: uppercase;
            margin-right: 4px;
            white-space: nowrap;
        }
        .bl-dots {
            flex: 1;
            border-bottom: 1.5px dotted #111;
            display: inline-flex;
            align-items: flex-end;
            margin-right: 12px;
            font-size: 14px;
            padding: 0 4px;
            height: 18px;
            color: #333;
        }
        .bl-dots:last-child { margin-right: 0; }
        
        .full-dots-group {
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
        }
        .full-dots-group .bl-label-block {
            font-weight: bold;
            font-size: 13px;
            text-transform: uppercase;
            margin-bottom: -2px;
        }
        .full-dots {
            width: 100%;
            border-bottom: 1.5px dotted #111;
            height: 22px;
            margin-bottom: 4px;
            font-size: 14px;
            color: #333;
            line-height: 22px;
            padding: 0 2px;
        }

        /* ─── Print Styles ─── */
        @page { size: A4; margin: 10mm; }
        @media print {
            body { background: white; padding: 0; }
            .report-sheet { border: 1px solid #111; padding: 4px; box-shadow: none; min-height: auto; width: 100%; max-width: none; }
            .report-sheet-inner { min-height: auto; border: 3px solid #111; }
            .top-bar, .print-btn-wrap { display: none !important; }
        }

        /* ─── Mobile Styles ─── */
        @media screen and (max-width: 768px) {
            body { padding: 12px 8px; }
            .report-sheet { padding: 2px; }
            .report-sheet-inner { padding: 12px 10px; border-width: 2px; }
            .report-header { flex-direction: column; text-align: center; gap: 10px; }
            .header-logo, .header-logo-placeholder, .passport-box { width: 70px; height: 70px; margin: 0 auto; }
            .header-center { padding: 0; }
            .header-center .school-name { font-size: 14px; line-height: 1.2; }
            .header-center .school-authority { font-size: 12px; }
            .header-center .school-address { font-size: 11px; }
            .title-bar { font-size: 13px; padding: 4px 0; margin: 8px 0; }
            .info-row { flex-direction: column; align-items: flex-start; gap: 4px; margin-bottom: 8px; }
            .info-label { margin-right: 0; margin-bottom: 2px; font-size: 11px; }
            .dotted-line { width: 100%; margin-right: 0; min-width: 100%; }
            .subjects-table { font-size: 11px; }
            .subjects-table th, .subjects-table td { padding: 4px 2px; }
            .subjects-table th { font-size: 10px; }
            .bottom-line-row { flex-direction: column; align-items: flex-start; gap: 4px; margin-bottom: 8px; }
            .bl-label { margin-right: 0; font-size: 11px; }
            .bl-dots { width: 100%; margin-right: 0; min-width: 100%; }
        }

        /* ─── Lookup Form ─── */
        .lookup-wrap {
            max-width: 400px;
            margin: 60px auto;
            background: #fff;
            border: 2px solid #111;
            padding: 40px 32px;
            text-align: center;
            font-family: 'Roboto', sans-serif;
        }
        .lookup-wrap h2 { font-size: 22px; margin-bottom: 8px; }
        .lookup-wrap p { font-size: 13px; color: #555; margin-bottom: 20px; }
        .lookup-wrap input {
            width: 100%;
            padding: 10px 14px;
            border: 1.5px solid #999;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            letter-spacing: .05em;
            text-transform: uppercase;
            outline: none;
            margin-bottom: 12px;
        }
        .lookup-wrap input:focus { border-color: #1e3a8a; }
        .lookup-wrap button {
            width: 100%;
            padding: 11px;
            background: #111;
            color: #fff;
            font-weight: 700;
            font-size: 14px;
            border: none;
            cursor: pointer;
            letter-spacing: .05em;
            text-transform: uppercase;
        }
        .lookup-wrap button:hover { background: #1e3a8a; }
        .lookup-links { margin-top: 18px; font-size: 12px; color: #999; }
        .lookup-links a { color: #1e3a8a; margin: 0 6px; }
    </style>
</head>
<body>

    <!-- Top Bar -->
    <div class="top-bar">
        <a href="index.html">&larr; Back Home</a>
        <button onclick="logout()">Logout</button>
    </div>

    <!-- Report Card Container -->
    <div id="report-card"></div>

    <!-- Print Button -->
    <div class="print-btn-wrap">
        <button class="print-btn" onclick="window.print()">
            <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
            Print / Download
        </button>
    </div>

    <script src="js/storage.js?v=2"></script>
    <script src="js/app.js?v=2"></script>
    <script>
        /* ─────────────── INIT ─────────────── */
        async function init() {
            const session = sessionStorage.getItem('currentUser');
            const auth = session ? JSON.parse(session) : null;

            let targetStudentId = auth?.type === 'student' ? auth.id : null;
            const urlParams = new URLSearchParams(window.location.search);
            const queryStudentId = urlParams.get('student_id');
            if (queryStudentId) targetStudentId = queryStudentId;

            if (!targetStudentId) {
                renderAdminLookup(document.getElementById('report-card'));
                document.querySelector('.print-btn-wrap').style.display = 'none';
                return;
            }

            const container = document.getElementById('report-card');
            container.innerHTML = `<div style="padding:60px;text-align:center;font-family:sans-serif;color:#555;">Loading Report Card…</div>`;

            try {
                const data = await fetchStudentReport(targetStudentId);
                if (data && data.student) {
                    renderReport(data.student, data.settings);
                } else {
                    container.innerHTML = `<div style="padding:60px;text-align:center;font-family:sans-serif;color:#c00;">
                        <h3 style="font-size:20px;margin-bottom:8px;">Report Not Found</h3>
                        <p>No record found for ID: <strong>${targetStudentId}</strong></p>
                        <button onclick="renderAdminLookup(document.getElementById('report-card'))" style="margin-top:16px;color:#1e3a8a;border:none;background:none;cursor:pointer;font-size:14px;">Try Another &rarr;</button>
                    </div>`;
                    document.querySelector('.print-btn-wrap').style.display = 'none';
                }
            } catch (e) {
                console.error(e);
                container.innerHTML = `<div style="padding:60px;text-align:center;color:#c00;">Error loading report. Please try again.</div>`;
            }
        }

        /* ─────────────── GRADE CALC ─────────────── */
        function calculateGrade(score, gradingSystem) {
            if (gradingSystem && gradingSystem.length > 0) {
                for (let g of gradingSystem) {
                    if (score >= g.min && score <= g.max) return { grade: g.grade, remark: g.remark };
                }
            }
            if (score >= 80) return { grade: 'A', remark: 'Excellent' };
            if (score >= 70) return { grade: 'B', remark: 'Very Good' };
            if (score >= 60) return { grade: 'C', remark: 'Good' };
            if (score >= 50) return { grade: 'D', remark: 'Credit' };
            if (score >= 45) return { grade: 'E', remark: 'Pass' };
            return { grade: 'F', remark: 'Fail' };
        }

        function escapeHtml(t) {
            if (!t) return '';
            return t.toString().replace(/[&<>"']/g, m => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
        }

        /* ─────────────── RENDER ─────────────── */
        function renderReport(user, settings) {
            const container = document.getElementById('report-card');
            const gs = settings || {};
            const gradingSystem = gs.gradingSystem || null;

            /* collect approved scores */
            const approvedScores = (user.scores || []).filter(s => s.status === 'Approved');

            /* build table rows */
            const subjectRows = approvedScores.map((s, idx) => {
                const total = (Number(s.class) || 0) + (Number(s.exam) || 0);
                const gi = calculateGrade(total, gradingSystem);
                return `
                <tr>
                    <td class="subject-name">${escapeHtml(s.subject)}</td>
                    <td>${s.class !== undefined && s.class !== null && s.class !== '' ? s.class : ''}</td>
                    <td>${s.exam  !== undefined && s.exam  !== null && s.exam  !== '' ? s.exam  : ''}</td>
                    <td>${s.class !== '' && s.exam !== '' ? total : ''}</td>
                    <td>${s.position || ''}</td>
                    <td>${gi.remark}</td>
                </tr>`;
            }).join('');

            /* pad with empty rows (min 10 visible rows) */
            const minRows = 10;
            let emptyRows = '';
            const empties = minRows - approvedScores.length;
            if (empties > 0) {
                for (let i = 0; i < empties; i++) {
                    emptyRows += `<tr class="empty-row"><td class="subject-name">&nbsp;</td><td></td><td></td><td></td><td></td><td></td></tr>`;
                }
            }

            /* attendance */
            const att = user.attendance || {};
            const attPresent = att.present !== undefined ? att.present : '';
            const attTotal   = att.total   !== undefined ? att.total   : '';

            /* logo */
            const logoHtml = gs.schoolLogo
                ? `<img src="${gs.schoolLogo}" class="header-logo" alt="School Logo">`
                : `<div class="header-logo-placeholder">LOGO</div>`;

            /* watermark */
            const wmHtml = gs.schoolLogo
                ? `<div class="watermark"><img src="${gs.schoolLogo}" alt="watermark"></div>`
                : '';

            /* passport photo */
            const passportHtml = user.photo
                ? `<div class="passport-box"><img src="${user.photo}" alt="Photo"></div>`
                : `<div class="passport-box">Passport</div>`;

            container.innerHTML = `
            <div class="report-sheet">
              <div class="report-sheet-inner">
                ${wmHtml}

                <!-- ═══ HEADER ═══ -->
                <div class="report-header">
                    ${logoHtml}

                    <div class="header-center">
                        <div class="school-authority">${escapeHtml(gs.schoolAuthority || 'GHANA EDUCATION SERVICE')}</div>
                        <div class="school-name">${escapeHtml(gs.schoolName || 'General School')}</div>
                        <div class="school-address">
                            ${escapeHtml(gs.schoolAddress || '123 Education Lane')}<br>
                            Email: <a href="mailto:${escapeHtml(gs.contactEmail || 'admin@generalschool.com')}">${escapeHtml(gs.contactEmail || 'admin@generalschool.com')}</a>
                            ${gs.contactPhone ? '<br>Tel: ' + escapeHtml(gs.contactPhone) : ''}
                        </div>
                    </div>

                    ${passportHtml}
                </div>

                <!-- ═══ TITLE BAR ═══ -->
                <div class="title-bar">TERMINAL REPORT SHEET</div>

                <!-- ═══ STUDENT INFO ═══ -->
                <div class="info-row">
                    <span class="info-label">NAME:</span>
                    <span class="dotted-line">${escapeHtml(user.name || '')}</span>
                    <span class="info-label">CLASS:</span>
                    <span class="dotted-line" style="flex:0; min-width:120px;">${escapeHtml(user.class || '')}</span>
                </div>

                <div class="info-row">
                    <span class="info-label">ACADEMIC YEAR:</span>
                    <span class="dotted-line" style="flex:0; min-width:120px;">${escapeHtml(user.year || '')}</span>
                    <span class="info-label">TERM:</span>
                    <span class="dotted-line" style="flex:0; min-width:110px;">${escapeHtml(user.term || '')}</span>
                    <span class="info-label">CLASS NO.:</span>
                    <span class="dotted-line" style="flex:0; min-width:60px;">${escapeHtml(user.class_no || user.total_students || '')}</span>
                </div>

                <div class="info-row">
                    <span class="info-label">CLASS TEACHER:</span>
                    <span class="dotted-line">${escapeHtml(user.class_teacher || '')}</span>
                    <span class="info-label">POSITION:</span>
                    <span class="dotted-line" style="flex:0; min-width:80px;">${user.position ? user.position + (user.total_students ? ' / ' + user.total_students : '') : ''}</span>
                </div>

                <div class="info-row">
                    <span class="info-label">REOPENING DATE:</span>
                    <span class="dotted-line">${escapeHtml(user.reopening_date || gs.reopeningDate || '')}</span>
                </div>

                <!-- ═══ SUBJECTS TABLE ═══ -->
                <table class="subjects-table">
                    <thead>
                        <tr>
                            <th class="col-subject">SUBJECTS</th>
                            <th>Class Score<br>30%</th>
                            <th>Exams<br>Score 70%</th>
                            <th>Total Score<br>100%</th>
                            <th>Position</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${subjectRows}
                        ${emptyRows}
                    </tbody>
                </table>

                <!-- ═══ ATTENDANCE ═══ -->
                <div class="bottom-line-row">
                    <span class="bl-label">ATTENDANCE:</span>
                    <span class="bl-dots" style="flex:0; min-width:80px;">${attPresent}</span>
                    <span class="bl-label">OUT OF:</span>
                    <span class="bl-dots" style="flex:0; min-width:80px;">${attTotal}</span>
                    <span class="bl-label">PROMOTED TO:</span>
                    <span class="bl-dots">${escapeHtml(user.promoted_to || '')}</span>
                </div>

                <div class="full-dots-group">
                    <div class="bl-label-block">CONDUCT:</div>
                    <div class="full-dots">${user.conduct ? escapeHtml(user.conduct) : ''}</div>
                    <div class="full-dots"></div>
                    <div class="full-dots"></div>
                </div>

                <div class="bottom-line-row">
                    <span class="bl-label">ATTITUDE:</span>
                    <span class="bl-dots">${user.attitude ? escapeHtml(user.attitude) : ''}</span>
                    <span class="bl-label">INTEREST:</span>
                    <span class="bl-dots">${user.interest ? escapeHtml(user.interest) : ''}</span>
                </div>

                <div class="full-dots-group">
                    <div class="bl-label-block">CLASS TEACHER'S REMARKS:</div>
                    <div class="full-dots">${user.teacher_remark ? escapeHtml(user.teacher_remark) : ''}</div>
                    <div class="full-dots"></div>
                </div>

              </div>
            </div>`;
        }

        /* ─────────────── LOOKUP FORM ─────────────── */
        function renderAdminLookup(container) {
            container.innerHTML = `
                <div class="lookup-wrap">
                    <h2>Student Lookup</h2>
                    <p>Enter a Student ID to view their Terminal Report Sheet.</p>
                    <input type="text" id="lookup-id" placeholder="e.g. ST_001" autocomplete="off">
                    <button onclick="lookupStudent()">View Report &rarr;</button>
                    <div class="lookup-links">
                        <a href="admin-dashboard.html">Admin Dashboard</a> &bull;
                        <a href="teacher-portal.html">Teacher Portal</a>
                    </div>
                </div>`;

            setTimeout(() => {
                const inp = document.getElementById('lookup-id');
                if (inp) {
                    inp.focus();
                    inp.addEventListener('keypress', e => { if (e.key === 'Enter') lookupStudent(); });
                }
            }, 100);
        }

        function lookupStudent() {
            const id = document.getElementById('lookup-id').value.trim();
            if (id) window.location.search = '?student_id=' + encodeURIComponent(id);
        }

        init();
    </script>
</body>
</html>
