<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Report Card | General School</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Playfair+Display:ital,wght@0,600;0,700;1,600&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#1e3a8a', secondary: '#d97706', paper: '#f8fafc' },
                    fontFamily: { sans: ['Outfit', 'sans-serif'], serif: ['Times New Roman', 'Playfair Display', 'serif'], mono: ['Courier New', 'monospace'] }
                }
            }
        }
    </script>
    <style>
        @page { size: A4; margin: 0; }
        body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        @media print {
            body { background: white; padding: 0; }
            #report-card { box-shadow: none; border: none; margin: 0; width: 100%; max-width: none; border-radius: 0; }
            .print\:hidden { display: none !important; }
            .print\:block { display: block !important; }
            /* Force background colors */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            opacity: 0.08;
            pointer-events: none;
            z-index: 0;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 print:p-0 print:bg-white">

    <!-- Top Bar -->
    <div class="max-w-[210mm] mx-auto mb-6 flex justify-between items-center print:hidden">
        <a href="index.html" class="flex items-center gap-2 text-primary font-bold">
            <span>&larr; Back Home</span>
        </a>
        <button onclick="logout()" class="text-red-500 hover:text-red-700 font-medium">Logout</button>
    </div>

    <!-- Report Card Container -->
    <div id="report-card" class="w-full max-w-[210mm] mx-auto bg-white shadow-xl rounded-xl overflow-hidden print:shadow-none print:w-full print:max-w-none print:rounded-none relative">
        <!-- Content will be injected via JS -->
    </div>

    <div class="max-w-[210mm] mx-auto mt-8 text-center print:hidden">
        <button onclick="window.print()" class="bg-primary text-white px-8 py-3 rounded-full shadow-lg hover:bg-blue-800 transition flex items-center gap-2 mx-auto font-bold">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
            Print Report
        </button>
    </div>

    <script src="js/storage.js"></script>
    <script src="js/app.js"></script>
    <script>
        // Protect Page / Init
        async function init() {
            // PUBLIC ACCESS: No login required
            const session = sessionStorage.getItem('currentUser');
            const auth = session ? JSON.parse(session) : null;

            // Determine which student to show
            let targetStudentId = auth?.type === 'student' ? auth.id : null;
            
            const urlParams = new URLSearchParams(window.location.search);
            const queryStudentId = urlParams.get('student_id');

            // Query parameter overrides session
            if (queryStudentId) {
                targetStudentId = queryStudentId;
            }

            // If we don't have an ID yet, show the lookup form
            if (!targetStudentId) {
                renderAdminLookup(document.getElementById('report-card'));
                return;
            }
            
            // Show loading state
            const container = document.getElementById('report-card');
            container.innerHTML = `<div class="p-12 text-center text-gray-500">Loading Report Card for ${targetStudentId}...</div>`;

            try {
                const data = await fetchStudentReport(targetStudentId);
                
                if (data && data.student) {
                    renderReport(data.student, data.settings);
                } else {
                    container.innerHTML = `<div class="p-12 text-center text-red-500">
                        <h3 class="font-bold text-xl">Report Not Found</h3>
                        <p class="mt-2 text-sm">No academic record found for Student ID: ${targetStudentId}</p>
                        <button onclick="renderAdminLookup(document.getElementById('report-card'))" class="mt-4 text-blue-600 hover:underline">Try Another Search</button>
                    </div>`;
                }
            } catch (e) {
                console.error(e);
                container.innerHTML = `<div class="p-12 text-center text-red-500">Error loading report. Please try again.</div>`;
            }
        }

        function calculateGrade(score, gradingSystem) {
             // Use custom grading system if available
             if(gradingSystem && gradingSystem.length > 0) {
                 for(let g of gradingSystem) {
                     if(score >= g.min && score <= g.max) {
                         return { 
                             grade: g.grade, 
                             remark: g.remark, 
                             bg: g.bg || 'bg-blue-50', 
                             color: g.color || 'text-blue-700' 
                         };
                     }
                 }
             }

            // Default Colors
            if (score >= 80) return { grade: 'A', remark: 'Excellent', bg: 'bg-green-100', color: 'text-green-700' };
            if (score >= 70) return { grade: 'B', remark: 'Very Good', bg: 'bg-blue-100', color: 'text-blue-700' };
            if (score >= 60) return { grade: 'C', remark: 'Good', bg: 'bg-yellow-100', color: 'text-yellow-700' };
            if (score >= 50) return { grade: 'D', remark: 'Credit', bg: 'bg-orange-100', color: 'text-orange-700' };
            if (score >= 45) return { grade: 'E', remark: 'Pass', bg: 'bg-gray-100', color: 'text-gray-700' };
            return { grade: 'F', remark: 'Fail', bg: 'bg-red-100', color: 'text-red-700' };
        }

        function escapeHtml(text) {
             if(!text) return '';
             return text.toString().replace(/[&<>"']/g, function(m) { return {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'}[m]; });
        }

        // Render Report (Colorful + Watermark)
        function renderReport(user, settings) {
            const container = document.getElementById('report-card');
            const schoolData = { settings };
            
            // Calculate Totals and Rows
            let totalScore = 0;
            let approvedCount = 0;
            const rows = user.scores.map(s => {
                // Only show approved
                if(s.status !== 'Approved') return '';
                
                const total = (s.class || 0) + (s.exam || 0);
                totalScore += total;
                approvedCount++;
                const gradeInfo = calculateGrade(total, schoolData.settings.gradingSystem);
                
                return `
                    <tr class="border-b border-gray-200">
                        <td class="px-3 py-3 border-r border-gray-200 text-left font-sans font-medium text-gray-800 text-sm">${s.subject}</td>
                        <td class="px-3 py-3 border-r border-gray-200 text-center font-mono text-sm text-gray-600">${s.class}</td>
                        <td class="px-3 py-3 border-r border-gray-200 text-center font-mono text-sm text-gray-600">${s.exam}</td>
                        <td class="px-3 py-3 border-r border-gray-200 text-center font-bold font-mono text-sm text-gray-900">${total}</td>
                        <td class="px-3 py-3 border-r border-gray-200 text-center text-sm">
                            <span class="${gradeInfo.bg} ${gradeInfo.color} px-2 py-1 rounded font-bold shadow-sm inline-block min-w-[30px]">${gradeInfo.grade}</span>
                        </td>
                        <td class="px-3 py-3 border-gray-200 text-left pl-3 text-sm italic text-gray-500">${gradeInfo.remark}</td>
                    </tr>
                `;
            }).join('');

            const average = approvedCount > 0 ? (totalScore / approvedCount).toFixed(2) : "0.00";

            container.innerHTML = `
                <div class="max-w-[210mm] mx-auto bg-white p-8 border border-gray-200 print:border-none print:p-0 min-h-[297mm] relative">
                    
                    <!-- WATERMARK -->
                    ${schoolData.settings.schoolLogo ? 
                        `<div class="watermark">
                            <img src="${schoolData.settings.schoolLogo}" class="w-full h-full object-contain opacity-20 filter grayscale-0">
                        </div>` : ''
                    }

                    <!-- HEADER -->
                    <div class="text-center mb-6 pb-4 relative z-10 border-b-2 border-primary">
                        <div class="flex justify-between items-center mb-4">
                             <!-- Left Logo -->
                             ${schoolData.settings.schoolLogo ? 
                                `<img src="${schoolData.settings.schoolLogo}" class="h-24 w-24 object-contain">` : 
                                `<div class="w-20 h-20 bg-blue-50 rounded-lg flex items-center justify-center font-bold text-primary text-xl shadow-sm">LOGO</div>`
                             }
                             
                             <!-- Center Info -->
                             <div class="flex-1 px-4">
                                <h1 class="text-3xl font-black uppercase text-primary tracking-tight" style="font-family: 'Playfair Display', serif;">${escapeHtml(schoolData.settings.schoolName || 'General School')}</h1>
                                <p class="text-xs font-bold text-gray-500 uppercase tracking-[0.2em] mb-1">${escapeHtml(schoolData.settings.schoolMotto || 'Excellence in Education')}</p>
                                <p class="text-sm text-gray-600 font-medium">${escapeHtml(schoolData.settings.schoolAddress || '')}</p>
                                <p class="text-sm text-gray-600">${escapeHtml(schoolData.settings.contactPhone || '')} ‚Ä¢ ${escapeHtml(schoolData.settings.contactEmail || '')}</p>
                             </div>

                             <!-- Right (Empty for balance or QR code) -->
                             <div class="w-24"></div>
                        </div>
                        <h3 class="font-bold text-xl uppercase bg-primary text-white inline-block px-8 py-1 rounded-t-lg shadow-sm">Terminal Report</h3>
                    </div>

                    <!-- STUDENT INFO GRID -->
                    <div class="bg-blue-50/50 border border-blue-100 rounded-xl p-4 mb-6 relative z-10 shadow-sm">
                        <div class="grid grid-cols-2 gap-y-2 gap-x-8">
                            <div class="flex border-b border-blue-100 pb-1"><span class="font-bold text-gray-500 w-32 text-xs uppercase self-end">Student Name</span> <span class="font-serif font-bold text-xl text-primary truncate">${user.name}</span></div>
                            <div class="flex border-b border-blue-100 pb-1"><span class="font-bold text-gray-500 w-32 text-xs uppercase self-end">Student ID</span> <span class="font-mono text-lg text-gray-800">${user.id}</span></div>
                            
                            <div class="flex border-b border-blue-100 pb-1"><span class="font-bold text-gray-500 w-32 text-xs uppercase self-end">Class</span> <span class="font-bold text-gray-800">${user.class}</span></div>
                            <div class="flex border-b border-blue-100 pb-1"><span class="font-bold text-gray-500 w-32 text-xs uppercase self-end">Position</span> <span class="font-bold text-secondary text-lg">${user.position || '-'} <span class="text-xs text-gray-400 font-normal">/ ${user.total_students || '-'}</span></span></div>
                            
                            <div class="flex border-b border-blue-100 pb-1"><span class="font-bold text-gray-500 w-32 text-xs uppercase self-end">Year</span> <span class="font-serif text-gray-800">${user.year}</span></div>
                            <div class="flex border-b border-blue-100 pb-1"><span class="font-bold text-gray-500 w-32 text-xs uppercase self-end">Term</span> <span class="font-serif text-gray-800">${user.term}</span></div>
                        </div>
                    </div>

                    <!-- ACADEMIC PERFORMANCE -->
                    <div class="relative z-10 bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden mb-6">
                        <table class="w-full text-black border-collapse">
                            <thead>
                                <tr class="bg-primary text-white">
                                    <th class="px-3 py-3 w-1/3 text-left text-xs font-bold uppercase tracking-wider">Subject</th>
                                    <th class="px-3 py-3 text-center text-xs font-bold uppercase tracking-wider border-l border-blue-800">Class (30)</th>
                                    <th class="px-3 py-3 text-center text-xs font-bold uppercase tracking-wider border-l border-blue-800">Exam (70)</th>
                                    <th class="px-3 py-3 text-center text-xs font-bold uppercase tracking-wider border-l border-blue-800">Total (100)</th>
                                    <th class="px-3 py-3 text-center text-xs font-bold uppercase tracking-wider border-l border-blue-800">Grade</th>
                                    <th class="px-3 py-3 text-left pl-3 text-xs font-bold uppercase tracking-wider border-l border-blue-800">Remarks</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                            <tfoot>
                                <tr class="bg-gray-50 border-t-2 border-primary">
                                    <td class="px-3 py-3 text-right font-bold uppercase text-xs text-gray-500">Performance Summary:</td>
                                    <td colspan="2" class="px-3 py-3 text-center font-bold text-sm text-gray-800">TOTAL: ${totalScore}</td>
                                    <td colspan="3" class="px-3 py-3 text-center font-bold text-sm text-primary">AVG: ${average}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- ATTENDANCE & CONDUCT GRID -->
                    <div class="grid grid-cols-2 gap-4 mb-8 relative z-10">
                        <div class="border border-indigo-100 bg-indigo-50/50 rounded-xl overflow-hidden">
                            <div class="bg-indigo-100 p-2 text-center font-bold text-xs uppercase text-indigo-800">Attendance Record</div>
                            <div class="p-4 text-center">
                                <span class="text-3xl font-bold text-indigo-900">${user.attendance.present}</span>
                                <span class="text-sm text-indigo-400 uppercase font-bold">Days Present</span>
                                <div class="text-xs text-indigo-400 mt-1">Out of ${user.attendance.total || 60} days</div>
                            </div>
                        </div>
                        <div class="border border-amber-100 bg-amber-50/50 rounded-xl overflow-hidden">
                            <div class="bg-amber-100 p-2 text-center font-bold text-xs uppercase text-amber-800">Conduct & Character</div>
                            <div class="p-4 text-center flex items-center justify-center h-full">
                                <p class="font-serif italic text-amber-900">"${user.conduct || 'Good behavior shown.'}"</p>
                            </div>
                        </div>
                    </div>

                    <!-- REMARKS SECTION -->
                    <div class="border border-gray-200 rounded-xl p-6 space-y-6 mb-8 relative z-10 bg-white shadow-sm">
                        <!-- Class Teacher -->
                        <div class="flex items-start gap-4">
                            <div class="bg-gray-100 p-2 rounded text-center min-w-[100px]">
                                <span class="block text-[10px] font-bold text-gray-400 uppercase">Class Teacher</span>
                                <span class="block text-xl">üë®‚Äçüè´</span>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-serif italic text-gray-700 bg-gray-50 p-3 rounded-lg border border-gray-100 mb-2">"${user.teacher_remark || 'Has shown good improvement in studies.'}"</p>
                                <div class="flex justify-end">
                                    <div class="text-center w-32 border-t border-gray-300 pt-1">
                                         <p class="text-[10px] font-bold uppercase text-gray-400">Signature</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Head Teacher -->
                        <div class="flex items-start gap-4 pt-4 border-t border-gray-100">
                             <div class="bg-primary/10 p-2 rounded text-center min-w-[100px]">
                                <span class="block text-[10px] font-bold text-primary uppercase">Head Teacher</span>
                                <span class="block text-xl">üéì</span>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-serif italic text-primary bg-primary/5 p-3 rounded-lg border border-primary/10 mb-2">"${user.head_remark || 'Promoted to the next class.'}"</p>
                                <div class="flex justify-end gap-8 items-end">
                                    <div class="text-center">
                                        <div class="w-24 h-24 border-2 border-dashed border-gray-300 rounded-full flex items-center justify-center text-[10px] text-gray-400 mb-1 opacity-50 rotate-[-12deg]">Official Stamp</div>
                                    </div>
                                    <div class="text-center w-32 border-t border-gray-300 pt-1">
                                         <p class="text-[10px] font-bold uppercase text-gray-400">Signature</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- KEY -->
                    <div class="text-center text-[10px] uppercase tracking-wider text-gray-400 pt-4 border-t border-gray-100 relative z-10">
                        <span class="font-bold text-white bg-gray-400 px-1 rounded mr-2">GRADING KEY</span> 
                        ${schoolData.settings.gradingSystem ? 
                            schoolData.settings.gradingSystem.map(g => `<span class="inline-block mx-2"><strong class="text-gray-600">${g.grade}</strong>: ${g.min}-${g.max}</span>`).join('<span class="text-gray-200">|</span>')
                            : 
                            'A: 80-100 ‚Ä¢ B: 70-79 ‚Ä¢ C: 60-69 ‚Ä¢ D: 50-59 ‚Ä¢ E: 45-49 ‚Ä¢ F: 0-44'
                        }
                    </div>
                </div>
            `;
        }

        function renderAdminLookup(container) {
            container.innerHTML = `
                <div class="max-w-md mx-auto mt-20 bg-white p-8 rounded-xl shadow-lg border border-gray-100 text-center">
                    <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                        üîç
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Student Lookup</h2>
                    <p class="text-gray-500 mb-6 text-sm">Enter a Student ID to view their report card.</p>
                    <div class="flex gap-2">
                        <input type="text" id="lookup-id" placeholder="e.g. ST_001" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition text-center uppercase font-mono">
                    </div>
                    <button onclick="lookupStudent()" class="w-full mt-4 bg-primary text-white py-3 rounded-lg font-bold hover:bg-blue-800 transition shadow-lg shadow-blue-500/20">View Report</button>
                    
                    <div class="mt-6 pt-6 border-t border-gray-100 flex justify-center gap-4 text-sm text-gray-400">
                        <a href="admin-dashboard.html" class="hover:text-primary">Admin Dashboard</a>
                        <span>‚Ä¢</span>
                        <a href="teacher-portal.html" class="hover:text-primary">Teacher Portal</a>
                    </div>
                </div>
            `;
            // Focus input
            setTimeout(() => {
                const input = document.getElementById('lookup-id');
                if(input) input.focus();
            }, 100);
            
            // Allow Enter key
            const input = document.getElementById('lookup-id');
            if(input) {
                input.addEventListener('keypress', function(e) {
                    if(e.key === 'Enter') lookupStudent();
                });
            }
        }
        
        function lookupStudent() {
            const id = document.getElementById('lookup-id').value.trim();
            if(id) {
                window.location.search = '?student_id=' + encodeURIComponent(id);
            }
        }

        init();
    </script>
</body>
</html>
