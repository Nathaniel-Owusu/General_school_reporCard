<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | General School</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { primary: '#0f172a', accent: '#3b82f6', secondary: '#f59e0b' }, fontFamily: { sans: ['Outfit', 'sans-serif'] } }
            }
        }
    </script>
</head>
<body class="bg-gray-50 h-screen flex overflow-hidden font-sans text-gray-800">

    <!-- Mobile Menu Toggle -->
    <button onclick="toggleMobileMenu()" class="md:hidden fixed top-4 left-4 z-50 bg-primary text-white p-3 rounded-xl shadow-lg">
        <ion-icon name="menu" class="text-2xl"></ion-icon>
    </button>

    <!-- Mobile Overlay -->
    <div id="mobile-overlay" class="hidden md:hidden fixed inset-0 bg-black/50 z-30" onclick="toggleMobileMenu()"></div>

    <!-- Sidebar -->
    <aside id="mobile-sidebar" class="w-72 bg-primary text-white flex flex-col shadow-2xl relative z-40 fixed md:relative h-full transform -translate-x-full md:translate-x-0 transition-transform duration-300">
        <div class="h-20 flex items-center gap-3 px-8 border-b border-gray-800 bg-gray-900/50">
            <div class="w-8 h-8 rounded-lg bg-accent flex items-center justify-center text-white">
                <ion-icon name="school" class="text-xl"></ion-icon>
            </div>
            <span class="font-bold text-lg tracking-wide">Admin Panel</span>
        </div>

        <nav class="flex-1 py-6 px-4 space-y-2">
            <button onclick="switchView('dashboard')" id="nav-dashboard" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-accent text-white font-medium shadow-lg shadow-blue-900/20 transition-all">
                <ion-icon name="grid-outline" class="text-xl"></ion-icon> Dashboard
            </button>
            <button onclick="switchView('classes')" id="nav-classes" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white font-medium transition-all">
                <ion-icon name="easel-outline" class="text-xl"></ion-icon> Manage Classes
            </button>
            <button onclick="switchView('teachers')" id="nav-teachers" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white font-medium transition-all">
                <ion-icon name="people-outline" class="text-xl"></ion-icon> Manage Teachers
            </button>
            <button onclick="switchView('subjects')" id="nav-subjects" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white font-medium transition-all">
                <ion-icon name="book-outline" class="text-xl"></ion-icon> Manage Subjects
            </button>
            <button onclick="switchView('settings')" id="nav-settings" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white font-medium transition-all">
                <ion-icon name="settings-outline" class="text-xl"></ion-icon> System Settings
            </button>
            <button onclick="switchView('results')" id="nav-results" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white font-medium transition-all">
                <ion-icon name="checkmark-done-circle-outline" class="text-xl"></ion-icon> Review Results
            </button>
            <a href="teacher-portal.html" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-400 hover:bg-gray-800 hover:text-white font-medium transition-all">
                <ion-icon name="key-outline" class="text-xl"></ion-icon> Teacher View
            </a>
        </nav>

        <div class="p-6 border-t border-gray-800">
            <button onclick="logout()" class="flex items-center gap-2 text-red-400 hover:text-red-300 transition w-full px-4 py-2 hover:bg-gray-800 rounded-lg">
                <ion-icon name="log-out-outline" class="text-xl"></ion-icon> <span class="font-medium">Sign Out</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col bg-gray-50 h-screen overflow-hidden">
        
        <!-- Header -->
        <header class="h-16 md:h-20 bg-white border-b border-gray-200 flex items-center justify-between px-4 md:px-8 shadow-sm z-10">
            <div class="ml-12 md:ml-0">
                <h2 class="text-lg md:text-2xl font-bold text-gray-800" id="page-title">Dashboard</h2>
                <p class="text-xs md:text-sm text-gray-400 hidden sm:block">Welcome back, Admin</p>
            </div>
            <div class="flex items-center gap-2 md:gap-4">
                 <div class="md:hidden">
                     <button onclick="logout()" class="p-2 rounded-lg hover:bg-gray-100 text-red-500">
                         <ion-icon name="log-out-outline" class="text-xl"></ion-icon>
                     </button>
                 </div>
                <div class="hidden md:flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-accent flex items-center justify-center text-white font-bold">
                        A
                    </div>
                </div>
            </div>
        </header>

        <!-- Page Content Container -->
        <div class="flex-1 overflow-y-auto px-3 md:px-8 py-4 md:py-8">
            
            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="space-y-8 animate-fade-in">
                <!-- Data Management Bar -->
                <div class="bg-gray-900 rounded-2xl p-6 text-white flex flex-col md:flex-row justify-between items-center shadow-xl mask-pattern relative overflow-hidden">
                     <div class="absolute inset-0 bg-accent opacity-10 pattern-dots"></div>
                     <div class="relative z-10 flex flex-col md:flex-row items-center gap-6 w-full justify-between">
                         <div class="flex items-center gap-4">
                             <div class="w-12 h-12 rounded-xl bg-white/10 flex items-center justify-center text-2xl">ðŸ’¾</div>
                             <div>
                                 <h3 class="font-bold text-lg">System Data Control</h3>
                                 <p class="text-blue-200 text-sm">Backup or restore your database safely.</p>
                             </div>
                         </div>
                         <div class="flex gap-4">
                             <button onclick="backupData()" class="px-4 py-2 bg-accent hover:bg-blue-600 rounded-lg font-bold shadow-lg transition flex items-center gap-2">
                                 <ion-icon name="cloud-download-outline"></ion-icon> Backup
                             </button>
                             <label class="px-4 py-2 bg-white/10 hover:bg-white/20 border border-white/20 rounded-lg font-bold transition flex items-center gap-2 cursor-pointer">
                                 <ion-icon name="cloud-upload-outline"></ion-icon> Restore
                                 <input type="file" id="restore-file" accept=".json" class="hidden" onchange="restoreData(this)">
                             </label>
                             <button onclick="hardResetSystem()" class="px-4 py-2 bg-red-500/80 hover:bg-red-600 rounded-lg font-bold transition flex items-center gap-2" title="Reset to Factory Settings">
                                <ion-icon name="refresh-circle-outline" class="text-xl"></ion-icon> Reset
                            </button>
                         </div>
                     </div>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4 hover:shadow-md transition">
                        <div class="w-16 h-16 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center text-3xl">
                            <ion-icon name="people"></ion-icon>
                        </div>
                        <div>
                            <p class="text-gray-400 text-sm font-bold uppercase tracking-wider">Total Students</p>
                            <h3 class="text-3xl font-bold text-gray-900" id="count-students">0</h3>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4 hover:shadow-md transition">
                        <div class="w-16 h-16 rounded-xl bg-green-50 text-green-600 flex items-center justify-center text-3xl">
                            <ion-icon name="briefcase"></ion-icon>
                        </div>
                        <div>
                            <p class="text-gray-400 text-sm font-bold uppercase tracking-wider">Teachers</p>
                            <h3 class="text-3xl font-bold text-gray-900" id="count-teachers">0</h3>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4 hover:shadow-md transition">
                        <div class="w-16 h-16 rounded-xl bg-purple-50 text-purple-600 flex items-center justify-center text-3xl">
                            <ion-icon name="library"></ion-icon>
                        </div>
                        <div>
                            <p class="text-gray-400 text-sm font-bold uppercase tracking-wider">Classes</p>
                            <h3 class="text-3xl font-bold text-gray-900" id="count-classes">0</h3>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex items-center gap-4 hover:shadow-md transition">
                        <div class="w-16 h-16 rounded-xl bg-orange-50 text-orange-600 flex items-center justify-center text-3xl">
                            <ion-icon name="book"></ion-icon>
                        </div>
                        <div>
                            <p class="text-gray-400 text-sm font-bold uppercase tracking-wider">Subjects</p>
                            <h3 class="text-3xl font-bold text-gray-900" id="count-subjects">0</h3>
                        </div>
                    </div>
                </div>

                <!-- Chart & Student Management Section -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Student Table -->
                    <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                            <h3 class="font-bold text-lg text-gray-800">Student Directory</h3>
                             <button onclick="openAddStudentModal()" class="bg-gray-900 hover:bg-black text-white px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2">
                                <ion-icon name="add"></ion-icon> Add Student
                            </button>
                        </div>
                        
                        <!-- Filter Bar -->
                        <div class="flex gap-4 mb-4">
                            <div class="relative flex-1">
                                <ion-icon name="search-outline" class="absolute left-3 top-3 text-gray-400"></ion-icon>
                                <input type="text" id="search-input" onkeyup="renderStudents()" placeholder="Search Name or ID..." class="w-full pl-10 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-lg outline-none focus:ring-2 focus:ring-accent">
                            </div>
                            <select id="filter-class" onchange="renderStudents()" class="px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg outline-none focus:ring-2 focus:ring-accent w-1/3">
                                <option value="">All Classes</option>
                            </select>
                        </div>

                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-gray-50 text-gray-400 font-bold uppercase text-xs">
                                    <tr>
                                        <th class="px-4 py-3">ID</th>
                                        <th class="px-4 py-3">Name</th>
                                        <th class="px-4 py-3">Class</th>
                                        <th class="px-4 py-3">Status</th>
                                        <th class="px-4 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-100" id="student-table-body">
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-4 flex justify-between items-center text-xs text-gray-400">
                            <span id="showing-count">Showing 0 students</span>
                            <div class="flex gap-2">
                                <button class="p-2 bg-gray-100 rounded hover:bg-gray-200 disabled:opacity-50"><ion-icon name="chevron-back"></ion-icon></button>
                                <button class="p-2 bg-gray-100 rounded hover:bg-gray-200 disabled:opacity-50"><ion-icon name="chevron-forward"></ion-icon></button>
                            </div>
                        </div>
                    </div>

                    <!-- Simple Chart -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 h-fit">
                        <h3 class="font-bold text-lg text-gray-800 mb-6">Enrollment Overview</h3>
                        <canvas id="enrollmentChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- VIEW: SUBJECTS -->
             <div id="view-subjects" class="space-y-8 hidden animate-fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    
                    <!-- Subject Master List -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                        <div class="flex justify-between items-center mb-6">
                             <div>
                                <h3 class="font-bold text-xl text-gray-800">All Subjects</h3>
                                <p class="text-gray-400 text-sm">Manage the school's curriculum.</p>
                            </div>
                            <button onclick="openAddSubjectModal()" class="bg-primary hover:bg-gray-800 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg transition flex items-center gap-2">
                                <ion-icon name="add"></ion-icon> New Subject
                            </button>
                        </div>
                        <div class="overflow-y-auto max-h-[500px]">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50 text-gray-500 font-bold uppercase text-xs sticky top-0">
                                    <tr>
                                        <th class="px-4 py-3">Code</th>
                                        <th class="px-4 py-3">Subject</th>
                                        <th class="px-4 py-3">Status</th>
                                        <th class="px-4 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-50" id="subject-table-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Class Assignment -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 flex flex-col">
                        <div class="mb-6 border-b border-gray-100 pb-4">
                            <h3 class="font-bold text-xl text-gray-800">Class Assignments</h3>
                            <p class="text-gray-400 text-sm">Control which subjects are taught in each class.</p>
                        </div>
                        
                        <div class="space-y-4 flex-1">
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-gray-500 uppercase">Select Class</label>
                                <select id="assign-class-select" onchange="loadClassSubjects()" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-accent"></select>
                            </div>

                            <div class="relative bg-gray-50 rounded-xl border border-gray-200 p-4 flex-1 overflow-hidden flex flex-col">
                                <div class="flex justify-between items-center mb-3">
                                    <label class="text-xs font-bold text-gray-500 uppercase">Available Subjects</label>
                                    <div class="space-x-2">
                                         <button type="button" onclick="toggleAllSubjects(true)" class="text-xs font-bold text-accent hover:underline">Select All</button>
                                         <span class="text-gray-300">|</span>
                                         <button type="button" onclick="toggleAllSubjects(false)" class="text-xs font-bold text-gray-400 hover:underline">Clear</button>
                                    </div>
                                </div>
                                <div id="assignment-checkboxes" class="space-y-2 overflow-y-auto max-h-[350px] pr-2">
                                    <!-- Checkboxes -->
                                    <p class="text-gray-400 text-sm italic text-center py-10">Select a class to configure subjects.</p>
                                </div>
                            </div>
                            
                            <button onclick="saveClassSubjects()" class="w-full py-3 bg-secondary text-white rounded-xl font-bold hover:bg-amber-600 shadow-lg transition">
                                <ion-icon name="save"></ion-icon> Save Assignments
                            </button>
                        </div>
                    </div>

                </div>
            </div>

            <!-- VIEW: CLASSES -->
             <div id="view-classes" class="space-y-8 hidden animate-fade-in">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="font-bold text-xl text-gray-800">Class Management</h3>
                            <p class="text-gray-400 text-sm">Create classes and assign teachers.</p>
                        </div>
                        <button onclick="openAddClassModal()" class="bg-secondary hover:bg-amber-600 text-white px-5 py-2.5 rounded-lg font-bold shadow-lg shadow-amber-500/20 transition flex items-center gap-2">
                            <ion-icon name="add-circle"></ion-icon> New Class
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="class-grid">
                        <!-- Classes Cards will go here -->
                    </div>
                </div>
            </div>

            <!-- VIEW: TEACHERS -->
             <div id="view-teachers" class="space-y-8 hidden animate-fade-in">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                    <div class="flex justify-between items-center mb-6">
                         <div>
                            <h3 class="font-bold text-xl text-gray-800">Faculty Staff</h3>
                            <p class="text-gray-400 text-sm">Manage teacher access and assignments.</p>
                        </div>
                        <button onclick="openAddTeacherModal()" class="bg-accent hover:bg-blue-600 text-white px-5 py-2.5 rounded-lg font-bold shadow-lg shadow-blue-500/20 transition flex items-center gap-2">
                            <ion-icon name="person-add"></ion-icon> New Teacher
                        </button>
                    </div>
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 text-gray-500 font-bold uppercase text-xs">
                            <tr>
                                <th class="px-6 py-4 rounded-l-lg">ID</th>
                                <th class="px-6 py-4">Teacher</th>
                                <th class="px-6 py-4">Classes</th>
                                <th class="px-6 py-4 rounded-r-lg text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-50" id="teacher-table-body"></tbody>
                    </table>
                </div>
            </div>
            <!-- VIEW: SETTINGS -->
            <div id="view-settings" class="space-y-6 hidden animate-fade-in">
                <!-- Settings Navigation -->
                <div class="flex gap-2 overflow-x-auto pb-2 border-b border-gray-200">
                    <button onclick="switchSettingsTab('general')" id="tab-general" class="px-4 py-2 rounded-lg font-bold text-sm bg-accent text-white shadow-md transition whitespace-nowrap">General Info</button>
                    <button onclick="switchSettingsTab('grading')" id="tab-grading" class="px-4 py-2 rounded-lg font-bold text-sm text-gray-500 hover:bg-gray-100 transition whitespace-nowrap">Grading System</button>
                    <button onclick="switchSettingsTab('attendance')" id="tab-attendance" class="px-4 py-2 rounded-lg font-bold text-sm text-gray-500 hover:bg-gray-100 transition whitespace-nowrap">Attendance</button>
                    <button onclick="switchSettingsTab('system')" id="tab-system" class="px-4 py-2 rounded-lg font-bold text-sm text-gray-500 hover:bg-gray-100 transition whitespace-nowrap">System</button>
                    <button onclick="switchSettingsTab('academic')" id="tab-academic" class="px-4 py-2 rounded-lg font-bold text-sm text-gray-500 hover:bg-gray-100 transition whitespace-nowrap">Academic Year</button>
                    <button onclick="switchSettingsTab('data')" id="tab-data" class="px-4 py-2 rounded-lg font-bold text-sm text-gray-500 hover:bg-gray-100 transition whitespace-nowrap">Data Management</button>
                </div>

                <!-- TAB: GENERAL -->
                <div id="set-general" class="settings-tab">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 max-w-4xl">
                        <h3 class="font-bold text-xl text-gray-800 mb-6">School Identity</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Data Fields -->
                            <div class="space-y-4">
                                 <div>
                                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">School Name</label>
                                    <input type="text" id="set-school-name" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-accent">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Motto</label>
                                    <input type="text" id="set-school-motto" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-accent">
                                </div>
                                 <div>
                                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Address</label>
                                    <textarea id="set-school-address" rows="2" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-accent"></textarea>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Phone</label>
                                        <input type="text" id="set-contact-phone" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-accent">
                                    </div>
                                    <div>
                                         <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Email</label>
                                        <input type="email" id="set-contact-email" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-accent">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Logo Upload -->
                            <div class="flex flex-col items-center justify-center bg-gray-50 border-2 border-dashed border-gray-200 rounded-xl p-8">
                                 <div id="logo-preview-area" class="mb-4 w-40 h-40 flex items-center justify-center">
                                     <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center shadow-sm">
                                         <ion-icon name="image-outline" class="text-3xl text-gray-300"></ion-icon>
                                     </div>
                                 </div>
                                 <label class="cursor-pointer bg-white border border-gray-200 px-4 py-2 rounded-lg font-bold text-sm text-gray-600 hover:bg-gray-50 shadow-sm transition">
                                     Upload Logo
                                     <input type="file" id="set-logo-upload" accept="image/*" class="hidden" onchange="handleLogoUpload(this)">
                                 </label>
                                 <p class="text-xs text-gray-400 mt-2 text-center">PNG, JPG up to 1MB.<br>Will be auto-resized.</p>
                            </div>
                        </div>
                        <div class="mt-8 pt-6 border-t border-gray-100 flex justify-end">
                            <button onclick="saveGeneralSettings()" class="bg-accent text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-600 transition shadow-lg">Save Changes</button>
                        </div>
                    </div>
                </div>

                <!-- TAB: GRADING -->
                <div id="set-grading" class="settings-tab hidden">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                         <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-xl text-gray-800">Grading System</h3>
                            <button onclick="addGradingRow()" class="px-3 py-1.5 bg-gray-900 text-white rounded-lg text-sm font-bold hover:bg-black transition flex items-center gap-2">
                                <ion-icon name="add"></ion-icon> Add Range
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50 text-gray-500 font-bold uppercase text-xs">
                                    <tr>
                                        <th class="px-4 py-3 w-24">Min %</th>
                                        <th class="px-4 py-3 w-24">Max %</th>
                                        <th class="px-4 py-3 w-24">Grade</th>
                                        <th class="px-4 py-3">Remark</th>
                                        <th class="px-4 py-3 w-24 text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="grading-table-body" class="divide-y divide-gray-100">
                                    <!-- JS Injected -->
                                </tbody>
                            </table>
                        </div>
                         <div class="mt-8 pt-6 border-t border-gray-100 flex justify-end">
                            <button onclick="saveGradingSettings()" class="bg-accent text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-600 transition shadow-lg">Save Rules</button>
                        </div>
                    </div>
                </div>

                <!-- TAB: ATTENDANCE -->
                <div id="set-attendance" class="settings-tab hidden">
                     <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 max-w-xl">
                         <h3 class="font-bold text-xl text-gray-800 mb-6">Attendance Configuration</h3>
                         <div class="space-y-4">
                             <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Total School Days (Term)</label>
                                <input type="number" id="set-att-days" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-accent">
                            </div>
                             <div>
                                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Default Present Days</label>
                                <input type="number" id="set-att-default" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none focus:ring-2 focus:ring-accent">
                                <p class="text-xs text-gray-400 mt-1">This will be the initial value for new students.</p>
                            </div>
                         </div>
                          <div class="mt-8 pt-6 border-t border-gray-100 flex justify-end">
                            <button onclick="saveAttendanceSettings()" class="bg-accent text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-600 transition shadow-lg">Save Settings</button>
                        </div>
                     </div>
                </div>

                <!-- TAB: SYSTEM -->
                <div id="set-system" class="settings-tab hidden">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 max-w-2xl">
                        <h3 class="font-bold text-xl text-gray-800 mb-6">System Toggles</h3>
                        <div class="space-y-6">
                             <!-- Teacher Edit -->
                             <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-100">
                                 <div>
                                     <h4 class="font-bold text-gray-800">Teacher Editing</h4>
                                     <p class="text-sm text-gray-400">Allow teachers to edit results after submission.</p>
                                 </div>
                                 <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="toggle-teacher-edit" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent"></div>
                                </label>
                             </div>
                             
                             <!-- Position -->
                             <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-100">
                                 <div>
                                     <h4 class="font-bold text-gray-800">Show Class Position</h4>
                                     <p class="text-sm text-gray-400">Display "1st", "2nd" etc. on report cards.</p>
                                 </div>
                                 <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="toggle-show-pos" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent"></div>
                                </label>
                             </div>

                             <!-- Attendance -->
                             <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-100">
                                 <div>
                                     <h4 class="font-bold text-gray-800">Show Attendance</h4>
                                     <p class="text-sm text-gray-400">Display attendance section on report cards.</p>
                                 </div>
                                 <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="toggle-show-att" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent"></div>
                                </label>
                             </div>

                             <!-- Watermark -->
                             <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl border border-gray-100">
                                 <div>
                                     <h4 class="font-bold text-gray-800">Print Watermark</h4>
                                     <p class="text-sm text-gray-400">Add faint school logo watermark to backgrounds.</p>
                                 </div>
                                 <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="toggle-show-watermark" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent"></div>
                                </label>
                             </div>


                        </div>
                         <div class="mt-8 pt-6 border-t border-gray-100 flex justify-end">
                            <button onclick="saveSystemSettings()" class="bg-accent text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-600 transition shadow-lg">Update System</button>
                        </div>
                    </div>
                </div>

                <!-- TAB: ACADEMIC (Existing +) -->
                <div id="set-academic" class="settings-tab hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Term Management Card (COPIED FROM ORIGINAL) -->
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 flex flex-col relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-secondary/10 rounded-full -mr-10 -mt-10 blur-2xl"></div>
                             <div class="flex items-start justify-between mb-6 relative z-10">
                                <div>
                                    <h3 class="font-bold text-xl text-gray-800">Current Term</h3>
                                    <p class="text-gray-400 text-sm">Set the active term for the whole school.</p>
                                </div>
                                <div class="w-10 h-10 rounded-xl bg-orange-100 text-orange-600 flex items-center justify-center text-xl">
                                    <ion-icon name="calendar-outline"></ion-icon>
                                </div>
                            </div>
                             <div class="space-y-4 flex-1 relative z-10">
                                <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Select Active Term</label>
                                    <div class="grid grid-cols-3 gap-2">
                                        <button onclick="setActiveTerm('1st Term')" id="btn-term-1" class="term-btn px-2 py-2 rounded-lg text-sm font-bold border transition">1st Term</button>
                                        <button onclick="setActiveTerm('2nd Term')" id="btn-term-2" class="term-btn px-2 py-2 rounded-lg text-sm font-bold border transition">2nd Term</button>
                                        <button onclick="setActiveTerm('3rd Term')" id="btn-term-3" class="term-btn px-2 py-2 rounded-lg text-sm font-bold border transition">3rd Term</button>
                                    </div>
                                </div>
                                <div class="bg-red-50 rounded-xl p-4 border border-red-100 flex items-center justify-between">
                                    <div>
                                        <h4 class="font-bold text-red-900 text-sm">Lock Results Entry</h4>
                                        <p class="text-red-700 text-xs mt-0.5">Prevent teachers from editing scores.</p>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="term-lock-toggle" class="sr-only peer" onchange="toggleTermLock()">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-500"></div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Academic Year Management (COPIED) -->
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 flex flex-col relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-accent/10 rounded-full -mr-10 -mt-10 blur-2xl"></div>
                            <div class="flex items-start justify-between mb-6 relative z-10">
                                <div>
                                    <h3 class="font-bold text-xl text-gray-800">Academic Year</h3>
                                    <p class="text-gray-400 text-sm">Manage school years and archiving.</p>
                                </div>
                                <button onclick="openAddYearModal()" class="px-3 py-1.5 bg-accent hover:bg-blue-600 text-white text-xs font-bold rounded-lg shadow transition flex items-center gap-1">
                                    <ion-icon name="add"></ion-icon> New Year
                                </button>
                            </div>
                            <div class="overflow-y-auto max-h-[300px] space-y-3 relative z-10" id="years-list">
                                <!-- Injected JS -->
                            </div>
                        </div>
                    </div>
                </div>

            <!-- TAB: DATA MANAGEMENT -->
            <div id="set-data" class="settings-tab hidden">
                 <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 max-w-2xl">
                     <h3 class="font-bold text-xl text-gray-800 mb-6 flex items-center gap-2"><ion-icon name="server-outline"></ion-icon> Data Management</h3>
                     
                     <div class="space-y-6">
                         <!-- Backup -->
                         <div class="bg-blue-50 border border-blue-100 rounded-xl p-6">
                             <div class="flex justify-between items-center mb-4">
                                 <div>
                                     <h4 class="font-bold text-blue-900">Backup System Data</h4>
                                     <p class="text-sm text-blue-700">Download a full backup of your school database (Students, Teachers, Settings).</p>
                                 </div>
                                 <button onclick="exportData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 transition shadow">
                                     <ion-icon name="cloud-download-outline" class="mr-2"></ion-icon> Download Backup
                                 </button>
                             </div>
                         </div>
                         
                         <!-- Restore -->
                         <div class="bg-green-50 border border-green-100 rounded-xl p-6">
                             <div class="flex justify-between items-center mb-4">
                                 <div>
                                     <h4 class="font-bold text-green-900">Restore Data</h4>
                                     <p class="text-sm text-green-700">Restore from a previously saved JSON backup file. <span class="font-bold text-red-600">Warning: Overwrites current data!</span></p>
                                 </div>
                                 <label class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 transition shadow cursor-pointer">
                                     <ion-icon name="cloud-upload-outline" class="mr-2"></ion-icon> Select File
                                     <input type="file" onchange="handleRestore(this)" accept=".json" class="hidden">
                                 </label>
                             </div>
                         </div>
                         
                          <!-- Reset -->
                         <div class="bg-red-50 border border-red-100 rounded-xl p-6 opacity-75 hover:opacity-100 transition">
                             <div class="flex justify-between items-center">
                                 <div>
                                     <h4 class="font-bold text-red-900">Factory Reset</h4>
                                     <p class="text-xs text-red-700">Clear all local data and reset to fresh state.</p>
                                 </div>
                                 <button onclick="if(confirm('Are you sure? This will wipe ALL data.')) { localStorage.clear(); location.reload(); }" class="text-red-600 font-bold hover:underline text-xs">Reset System</button>
                             </div>
                         </div>
                     </div>
                 </div>
            </div>
            
            </div>
            
            <!-- VIEW: RESULTS REVIEW -->
            <div id="view-results" class="space-y-8 hidden animate-fade-in">
                <!-- Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold text-gray-400 uppercase">Total Entries</p>
                            <h3 class="text-2xl font-bold text-gray-800" id="res-total">0</h3>
                        </div>
                        <div class="text-3xl text-gray-200"><ion-icon name="documents"></ion-icon></div>
                    </div>
                    <div class="bg-yellow-50 p-5 rounded-xl border border-yellow-100 shadow-sm flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold text-yellow-600 uppercase">Pending</p>
                            <h3 class="text-2xl font-bold text-yellow-800" id="res-pending">0</h3>
                        </div>
                        <div class="text-3xl text-yellow-200"><ion-icon name="time"></ion-icon></div>
                    </div>
                    <div class="bg-green-50 p-5 rounded-xl border border-green-100 shadow-sm flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold text-green-600 uppercase">Approved</p>
                            <h3 class="text-2xl font-bold text-green-800" id="res-approved">0</h3>
                        </div>
                        <div class="text-3xl text-green-200"><ion-icon name="checkmark-circle"></ion-icon></div>
                    </div>
                    <div class="bg-red-50 p-5 rounded-xl border border-red-100 shadow-sm flex items-center justify-between">
                        <div>
                            <p class="text-xs font-bold text-red-600 uppercase">Rejected</p>
                            <h3 class="text-2xl font-bold text-red-800" id="res-rejected">0</h3>
                        </div>
                        <div class="text-3xl text-red-200"><ion-icon name="close-circle"></ion-icon></div>
                    </div>
                </div>

                <!-- Filters & Table -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                    <div class="flex flex-col md:flex-row justify-between items-end md:items-center mb-6 gap-4">
                        <div>
                            <h3 class="font-bold text-lg text-gray-800">Results Approval Queue</h3>
                            <p class="text-gray-400 text-sm">Review student scores before publishing.</p>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="approveAllVisible()" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-bold shadow hover:bg-green-700 transition flex items-center gap-2">
                                <ion-icon name="checkmark-done"></ion-icon> Approve All Listed
                             </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Class</label>
                            <select id="res-filter-class" onchange="renderResults()" class="w-full px-3 py-2 bg-white border border-gray-200 rounded-lg outline-none focus:ring-2 focus:ring-accent"></select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Subject</label>
                             <select id="res-filter-subject" onchange="renderResults()" class="w-full px-3 py-2 bg-white border border-gray-200 rounded-lg outline-none focus:ring-2 focus:ring-accent"></select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Status</label>
                             <select id="res-filter-status" onchange="renderResults()" class="w-full px-3 py-2 bg-white border border-gray-200 rounded-lg outline-none focus:ring-2 focus:ring-accent">
                                 <option value="Pending">Pending Review</option>
                                 <option value="Approved">Approved</option>
                                 <option value="Rejected">Rejected</option>
                                 <option value="">All Statuses</option>
                             </select>
                        </div>
                         <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Search</label>
                            <input type="text" id="res-search" onkeyup="renderResults()" placeholder="Student Name/ID..." class="w-full px-3 py-2 bg-white border border-gray-200 rounded-lg outline-none focus:ring-2 focus:ring-accent">
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 text-gray-500 font-bold uppercase text-xs">
                                <tr>
                                    <th class="px-4 py-3">Student</th>
                                    <th class="px-4 py-3">Class & Subject</th>
                                    <th class="px-4 py-3 text-center">Class (30)</th>
                                    <th class="px-4 py-3 text-center">Exam (70)</th>
                                    <th class="px-4 py-3 text-center">Total</th>
                                    <th class="px-4 py-3 text-center">Status</th>
                                    <th class="px-4 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100" id="results-table-body">
                                <tr><td colspan="7" class="text-center py-8 text-gray-400">Loading results...</td></tr>
                            </tbody>
                        </table>
                    </div>
                     <div class="mt-4 flex justify-between items-center">
                        <p class="text-xs text-gray-400 italic" id="res-count-display">Showing 0 entries</p>
                     </div>
                </div>
            </div>

    <!-- Modals -->
    <!-- Add/Edit Student Modal -->
    <div id="add-student-modal" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm hidden flex items-center justify-center z-50 transition-opacity">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4 transform transition-all scale-100 animate-fade-in">
            <h2 class="text-2xl font-bold mb-6 text-gray-800" id="modal-title">Register New Student</h2>
            <form id="add-student-form" onsubmit="handleSaveStudent(event)" class="space-y-4">
                <input type="hidden" name="editModeId" id="edit-mode-id">
                
                <div class="space-y-1">
                    <label class="text-xs font-bold text-gray-500 uppercase">Full Name</label>
                    <input type="text" name="name" id="input-name" required placeholder="e.g. John Doe" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-accent outline-none">
                </div>
                
                <div class="space-y-1">
                    <label class="text-xs font-bold text-gray-500 uppercase">Index Number</label>
                    <input type="text" name="id" id="input-id" required placeholder="e.g. ST005" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-accent outline-none">
                </div>

                <div class="space-y-1">
                     <label class="text-xs font-bold text-gray-500 uppercase">Class Assignment</label>
                    <div class="grid grid-cols-2 gap-4">
                        <select name="class" id="student-class-select" required class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none"></select>
                        <select name="term" required class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none">
                            <option value="1st Term">1st Term</option>
                            <option value="2nd Term">2nd Term</option>
                            <option value="3rd Term">3rd Term</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-gray-500 uppercase">Gender</label>
                        <select name="gender" id="input-gender" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-gray-500 uppercase">Status</label>
                        <select name="status" id="input-status" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeModal('add-student-modal')" class="flex-1 py-3 border border-gray-200 rounded-xl font-bold hover:bg-gray-50 text-gray-600">Cancel</button>
                    <button type="submit" class="flex-1 py-3 bg-accent text-white rounded-xl font-bold hover:bg-blue-600 shadow-lg shadow-blue-500/30 transition-all">Save Student</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-sm mx-4 text-center">
            <div class="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                <ion-icon name="warning-outline"></ion-icon>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Delete Student?</h3>
            <p class="text-gray-500 mb-6">Are you sure you want to delete this student? This action cannot be undone.</p>
            <div class="flex gap-3">
                <button onclick="closeModal('delete-modal')" class="flex-1 py-2.5 border border-gray-200 rounded-xl font-bold hover:bg-gray-50 text-gray-600">Cancel</button>
                <button onclick="confirmDeleteStudent()" class="flex-1 py-2.5 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 shadow-lg shadow-red-500/30">Delete</button>
            </div>
        </div>
    </div>

     <!-- Add Class Modal -->
    <div id="add-class-modal" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">New Class</h2>
             <form onsubmit="handleAddClass(event)" class="space-y-4">
                <input type="hidden" name="id">
                <div>
                     <label class="text-xs font-bold text-gray-500 uppercase">Class Name</label>
                     <input type="text" name="name" required placeholder="e.g. JHS 1 A" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-secondary outline-none">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Level</label>
                    <select name="level" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none">
                        <option value="KG">Kindergarten (KG)</option>
                        <option value="Primary">Primary</option>
                        <option value="JHS">Junior High (JHS)</option>
                    </select>
                </div>
                </div>
                <div>
                     <label class="text-xs font-bold text-gray-500 uppercase">Class Teacher (Form Master)</label>
                     <select name="class_teacher_id" id="class-teacher-select" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none mb-4">
                         <option value="">-- No Class Teacher --</option>
                     </select>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase">Status</label>
                    <select name="active" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none">
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeModal('add-class-modal')" class="flex-1 py-3 border border-gray-200 rounded-xl font-bold hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="flex-1 py-3 bg-secondary text-white rounded-xl font-bold hover:bg-amber-600 shadow-lg shadow-amber-500/30">Save Class</button>
                </div>
             </form>
        </div>
    </div>

     <!-- Add Teacher Modal -->
    <div id="add-teacher-modal" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">New Teacher</h2>
             <form onsubmit="handleAddTeacher(event)" class="space-y-4">
                <input type="hidden" name="id">
                <input type="text" name="name" required placeholder="Full Name" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none">
                <input type="email" name="email" required placeholder="Login Email" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none">
                <input type="text" name="password" required value="password123" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none">
                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeModal('add-teacher-modal')" class="flex-1 py-3 border border-gray-200 rounded-xl font-bold hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="flex-1 py-3 bg-accent text-white rounded-xl font-bold hover:bg-blue-600 shadow-lg shadow-blue-500/30">Add Faculty</button>
                </div>
             </form>
        </div>
    </div>

    <!-- Add/Edit Subject Modal -->
    <div id="add-subject-modal" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4">
            <h2 class="text-2xl font-bold mb-6 text-gray-800" id="subject-modal-title">New Subject</h2>
             <form onsubmit="handleSaveSubject(event)" class="space-y-4">
                <input type="hidden" name="id">
                <div class="space-y-1">
                    <label class="text-xs font-bold text-gray-500 uppercase">Subject Name</label>
                    <input type="text" name="name" required placeholder="e.g. Mathematics" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none">
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-gray-500 uppercase">Short Code</label>
                    <input type="text" name="code" required placeholder="e.g. MATH" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none font-mono">
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-gray-500 uppercase">Education Level</label>
                    <select name="level" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none">
                        <option value="KG">Kindergarten (KG)</option>
                        <option value="Primary">Primary School</option>
                        <option value="JHS">Junior High (JHS)</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-xs font-bold text-gray-500 uppercase">Status</label>
                    <select name="status" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl outline-none">
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeModal('add-subject-modal')" class="flex-1 py-3 border border-gray-200 rounded-xl font-bold hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="flex-1 py-3 bg-primary text-white rounded-xl font-bold hover:bg-gray-800 shadow-lg">Save Subject</button>
                </div>
             </form>
        </div>
    </div>

    <!-- Manage Class Subjects Modal -->
    <div id="manage-subjects-modal" class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg mx-4 flex flex-col max-h-[90vh]">
            <h2 class="text-2xl font-bold mb-2 text-gray-800">Class Subjects</h2>
            <p class="text-sm text-gray-500 mb-6" id="manage-subjects-subtitle">Select subjects offered by this class.</p>
            
            <form id="manage-subjects-form" onsubmit="handleSaveClassSubjects(event)" class="flex flex-col flex-1 overflow-hidden">
                <input type="hidden" name="class_id">
                
                <div class="flex-1 overflow-y-auto pr-2 space-y-2" id="class-subjects-list">
                    <!-- Checkboxes injected here -->
                </div>

                <div class="pt-6 flex gap-3 mt-auto">
                    <button type="button" onclick="closeModal('manage-subjects-modal')" class="flex-1 py-3 border border-gray-200 rounded-xl font-bold hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="flex-1 py-3 bg-secondary text-white rounded-xl font-bold hover:bg-amber-600 shadow-lg shadow-amber-500/30">Save Assignments</button>
                </div>
             </form>
        </div>
    </div>

    <script src="js/storage.js"></script>
    <script src="js/app.js"></script>
    <script src="js/settings.js"></script>

    <script>
        checkAuth(['admin']);
        
        // Mobile Menu Toggle
        function toggleMobileMenu() {
            const sidebar = document.getElementById('mobile-sidebar');
            const overlay = document.getElementById('mobile-overlay');
            
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                sidebar.classList.add('translate-x-0');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                sidebar.classList.remove('translate-x-0');
                overlay.classList.add('hidden');
            }
        }
        
        let allStudents = []; 
 
        let allClasses = [];
        let allTeachers = [];

        async function initDashboard() {
            // Load Stats
            const stats = await fetchAdminData('stats');
            if (stats) {
                document.getElementById('count-students').innerText = stats.students || 0;
                document.getElementById('count-teachers').innerText = stats.teachers || 0;
                document.getElementById('count-classes').innerText = stats.classes || 0;
                document.getElementById('count-subjects').innerText = stats.subjects || 0;
            }

            // Load Classes for Filters
            allClasses = await fetchAdminData('classes') || [];
            const filter = document.getElementById('filter-class');
            filter.innerHTML = '<option value="">All Classes</option>' + 
                 allClasses.map(c => `<option value="${c.name}">${c.name}</option>`).join('');

            // Load Students
            await renderStudents();
            renderEnrollmentChart(stats);
        }

        // View Management
        const viewList = ['dashboard', 'classes', 'teachers', 'subjects', 'settings', 'results'];
        function switchView(viewName) {
            viewList.forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            
            // Update Nav
            viewList.forEach(v => {
                 const btn = document.getElementById(`nav-${v}`);
                 if(btn) {
                     btn.classList.remove('bg-accent', 'text-white', 'shadow-lg');
                     btn.classList.add('text-gray-400');
                 }
            });
            const activeBtn = document.getElementById(`nav-${viewName}`);
            if(activeBtn) {
                 activeBtn.classList.remove('text-gray-400', 'hover:bg-gray-800');
                 activeBtn.classList.add('bg-accent', 'text-white', 'shadow-lg');
            }

            // Dynamic Load
            if(viewName === 'classes') renderClasses();
            if(viewName === 'teachers') renderTeachers();
            if(viewName === 'subjects') initSubjectView();
            if(viewName === 'results') renderResults();
            if(viewName === 'settings') initSettingsView();
        }

        // Student Management
        let deleteTargetId = null;
        async function renderStudents() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const filterClass = document.getElementById('filter-class').value;
            
            const students = await fetchAdminData('students');
            allStudents = students || [];

            // Filter in memory for local engine
            let filtered = allStudents.filter(s => {
                const matchName = !search || s.name.toLowerCase().includes(search) || s.id.toLowerCase().includes(search);
                const matchClass = !filterClass || s.class === filterClass;
                return matchName && matchClass;
            });

            const tbody = document.getElementById('student-table-body');
            tbody.innerHTML = '';
            
            document.getElementById('showing-count').innerText = `Showing ${filtered.length} students`;
            
            if(filtered.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="5" class="py-10 text-center text-gray-400">No students found.</td></tr>`;
                 return;
            }

            filtered.forEach(student => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-100 hover:bg-gray-50 transition";
                tr.innerHTML = `
                    <td class="px-4 py-3 font-mono text-gray-500">${student.id}</td>
                    <td class="px-4 py-3 font-medium text-gray-900 flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center text-xs font-bold">
                            ${student.name.charAt(0)}
                        </div>
                        ${student.name}
                    </td>
                    <td class="px-4 py-3"><span class="px-2 py-1 bg-blue-50 text-blue-600 rounded text-[10px] font-bold">${student.class || 'Unassigned'}</span></td>
                    <td class="px-4 py-3"><span class="px-2 py-1 bg-green-50 text-green-600 rounded text-[10px] font-bold uppercase">Active</span></td>
                    <td class="px-4 py-3 text-right">
                         <div class="flex justify-end gap-2 group-hover:opacity-100 transition">
                            <button onclick="openAddStudentModal('${student.id}')" class="p-1.5 hover:bg-white text-gray-400 hover:text-accent rounded shadow-sm" title="Edit"><ion-icon name="create"></ion-icon></button>
                            <button onclick="openDeleteStudentModal('${student.id}')" class="p-1.5 hover:bg-white text-gray-400 hover:text-red-500 rounded shadow-sm" title="Delete"><ion-icon name="trash"></ion-icon></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Chart
        function renderEnrollmentChart(stats) {
            const ctx = document.getElementById('enrollmentChart').getContext('2d');
            if(window.myChart) window.myChart.destroy();

            window.myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Students', 'Teachers', 'Classes'],
                    datasets: [{
                        data: [stats?.students || 0, stats?.teachers || 0, stats?.classes || 0],
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b'],
                        borderWidth: 0
                    }]
                },
                options: { cutout: '70%', responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
        }

        // --- RESULTS REVIEW LOGIC ---
        
        let allResults = [];

        async function renderResults() {
             const filterClass = document.getElementById('res-filter-class').value;
             const filterSubject = document.getElementById('res-filter-subject').value;
             const filterStatus = document.getElementById('res-filter-status').value;
             const search = document.getElementById('res-search').value.toLowerCase();
             
             // Fetch all results flattened
             allResults = await fetchAdminData('results_queue') || [];

             // Update Stats
             document.getElementById('res-total').innerText = allResults.length;
             document.getElementById('res-pending').innerText = allResults.filter(r => r.status === 'Pending').length;
             document.getElementById('res-approved').innerText = allResults.filter(r => r.status === 'Approved').length;
             document.getElementById('res-rejected').innerText = allResults.filter(r => r.status === 'Rejected').length;

             // Populate Filters if empty (First Load)
             const classSelect = document.getElementById('res-filter-class');
             if(classSelect.children.length === 0) {
                 if(!allClasses || allClasses.length === 0) allClasses = await fetchAdminData('classes') || [];
                 classSelect.innerHTML = '<option value="">All Classes</option>' + 
                     allClasses.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
             }

             const subjectSelect = document.getElementById('res-filter-subject');
             if(subjectSelect.children.length === 0) {
                 const subjects = [...new Set(allResults.map(r => r.subject))].sort();
                 subjectSelect.innerHTML = '<option value="">All Subjects</option>' + subjects.map(s => `<option value="${s}">${s}</option>`).join('');
             }

             // Filter
             const filtered = allResults.filter(r => {
                 const matchClass = !filterClass || r.class === filterClass;
                 const matchSubject = !filterSubject || r.subject === filterSubject;
                 const matchStatus = !filterStatus || r.status === filterStatus;
                 const matchSearch = !search || r.student_name.toLowerCase().includes(search) || r.student_id.toLowerCase().includes(search);
                 return matchClass && matchSubject && matchStatus && matchSearch;
             });

             // Render
             const tbody = document.getElementById('results-table-body');
             tbody.innerHTML = '';
             document.getElementById('res-count-display').innerText = `Showing ${filtered.length} entries`;

             if(filtered.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="7" class="text-center py-8 text-gray-400">No results found matching filters.</td></tr>`;
                 return;
             }

             filtered.forEach(r => {
                 let statusColor = 'bg-yellow-50 text-yellow-600';
                 if(r.status === 'Approved') statusColor = 'bg-green-50 text-green-600';
                 if(r.status === 'Rejected') statusColor = 'bg-red-50 text-red-600';

                 const tr = document.createElement('tr');
                 tr.className = "border-b border-gray-100 hover:bg-gray-50 transition";
                 tr.innerHTML = `
                     <td class="px-4 py-3">
                         <div class="font-bold text-gray-800">${r.student_name}</div>
                         <div class="text-xs text-gray-400 font-mono">${r.student_id}</div>
                     </td>
                     <td class="px-4 py-3">
                         <div class="text-sm text-gray-600">${r.subject}</div>
                         <div class="text-xs text-blue-500 font-bold">${r.class}</div>
                     </td>
                     <td class="px-4 py-3 text-center font-mono">${r.class_score || '-'}</td>
                     <td class="px-4 py-3 text-center font-mono">${r.exam_score || '-'}</td>
                     <td class="px-4 py-3 text-center font-bold">${r.total}</td>
                     <td class="px-4 py-3 text-center">
                         <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${statusColor}">${r.status}</span>
                     </td>
                     <td class="px-4 py-3 text-right">
                         <div class="flex justify-end gap-2">
                             ${r.status !== 'Approved' ? `
                             <button onclick="updateResultStatus('${r.student_id}', '${r.subject_id}', 'Approved')" class="p-1 px-2 bg-green-100 text-green-700 hover:bg-green-200 rounded text-xs font-bold transition" title="Approve">
                                 <ion-icon name="checkmark"></ion-icon> Approve
                             </button>` : ''}
                             ${r.status !== 'Rejected' ? `
                             <button onclick="updateResultStatus('${r.student_id}', '${r.subject_id}', 'Rejected')" class="p-1 px-2 bg-red-100 text-red-700 hover:bg-red-200 rounded text-xs font-bold transition" title="Reject">
                                 <ion-icon name="close"></ion-icon> Reject
                             </button>` : ''}
                         </div>
                     </td>
                 `;
                 tbody.appendChild(tr);
             });
        }

        async function updateResultStatus(studentId, subjectId, newStatus) {
            const btn = event.target.closest('button');
            if(btn) {
                btn.innerHTML = '<ion-icon name="sync" class="animate-spin"></ion-icon>';
                btn.disabled = true;
            }

            const result = await fetchAdminData('update_result_status', { student_id: studentId, subject_id: subjectId, status: newStatus }, 'POST');
            if(result && result.success) {
                // Optimistic UI update or re-fetch
                await renderResults();
            } else {
                alert('Action failed');
                if(btn) btn.disabled = false;
            }
        }

        async function approveAllVisible() {
             const btn = document.querySelector('button[onclick="approveAllVisible()"]');
             const originalContent = btn.innerHTML;
             btn.innerHTML = '<ion-icon name="sync" class="animate-spin"></ion-icon> Processing...';
             btn.disabled = true;

             // Logic: get currently filtered items that are NOT approved
             const filterClass = document.getElementById('res-filter-class').value;
             // ... re-apply filter logic or look at filtered var if accessible.
             // Simpler: Just rely on allResults filtered again
             // For strictness, let's pass a bulk list of IDs
             
             // Re-filter here to be safe
             const search = document.getElementById('res-search').value.toLowerCase();
             const filterSubject = document.getElementById('res-filter-subject').value;
             const filterStatus = document.getElementById('res-filter-status').value;

             const toApprove = allResults.filter(r => {
                 const matchClass = !filterClass || r.class === filterClass;
                 const matchSubject = !filterSubject || r.subject === filterSubject;
                 const matchStatus = !filterStatus || r.status === filterStatus; // Usually we approve 'Pending', but button says 'Approve All Listed'
                 const matchSearch = !search || r.student_name.toLowerCase().includes(search);
                 return matchClass && matchSubject && matchStatus && matchSearch && r.status !== 'Approved';
             }).map(r => ({ student_id: r.student_id, subject_id: r.subject_id }));

             if(toApprove.length === 0) {
                 alert('No pending items to approve in current view.');
                 btn.innerHTML = originalContent;
                 btn.disabled = false;
                 return;
             }

             if(!confirm(`Approve ${toApprove.length} results?`)) {
                 btn.innerHTML = originalContent;
                 btn.disabled = false;
                 return;
             }

             const result = await fetchAdminData('bulk_approve', { items: toApprove }, 'POST');
             
             if(result && result.success) {
                 await renderResults();
                 alert('Bulk approval complete!');
             } else {
                 alert('Bulk action failed');
             }
             btn.innerHTML = originalContent;
             btn.disabled = false;
        }

        // --- MODAL & FORM HANDLERS ---
        // --- MODAL & FORM HANDLERS ---
        async function openAddStudentModal(studentId = null) {
             const modal = document.getElementById('add-student-modal');
             const form = document.getElementById('add-student-form');
             const title = document.getElementById('modal-title');
             
             // Populate Classes
             const classes = await fetchAdminData('classes');
             const classSelect = document.getElementById('student-class-select');
             classSelect.innerHTML = (classes || []).map(c => `<option value="${c.name}">${c.name}</option>`).join('');

             if(studentId) {
                 title.innerText = "Edit Student";
                 const student = allStudents.find(s => s.id == studentId);
                 if(student) {
                      document.getElementById('edit-mode-id').value = student.id;
                      document.getElementById('input-name').value = student.name;
                      const idInput = document.getElementById('input-id');
                      idInput.value = student.id;
                      idInput.readOnly = true; 
                      idInput.classList.add('bg-gray-100', 'cursor-not-allowed');
                      
                      document.getElementById('student-class-select').value = student.class;
                      document.getElementById('input-gender').value = student.gender || 'Male';
                      document.getElementById('input-status').value = student.status || 'Active';
                 }
             } else {
                 title.innerText = "Register New Student";
                 form.reset();
                 document.getElementById('edit-mode-id').value = "";
                 const idInput = document.getElementById('input-id');
                 idInput.readOnly = false;
                 idInput.classList.remove('bg-gray-100', 'cursor-not-allowed');
                 idInput.value = "";
                 document.getElementById('input-status').value = "Active";
             }
             
             modal.classList.remove('hidden');
        }

        async function handleSaveStudent(e) {
            e.preventDefault();
            const form = e.target;
            const editId = document.getElementById('edit-mode-id').value;
            
            const data = {
                id: editId || document.getElementById('input-id').value, 
                name: document.getElementById('input-name').value,
                class: document.getElementById('student-class-select').value,
                gender: document.getElementById('input-gender').value,
                status: document.getElementById('input-status').value
            };
            
            if(!data.id) { alert("ID is required"); return; }

            const result = await fetchAdminData('add_student', data, 'POST');
            if (result && result.success) {
                alert('Student saved successfully');
                closeModal('add-student-modal');
                initDashboard();
                if(!editId) form.reset(); 
            } else {
                alert('Error: ' + (result?.message || 'Failed to save student'));
            }
        }
        
        function openDeleteStudentModal(id) {
            deleteTargetId = id;
            document.getElementById('delete-modal').classList.remove('hidden');
        }
        
        async function confirmDeleteStudent() {
            if(!deleteTargetId) return;
            const result = await fetchAdminData('delete_student', { id: deleteTargetId }, 'POST');
            if(result && result.success) {
                alert('Student deleted');
                closeModal('delete-modal');
                initDashboard();
            } else {
                alert('Failed to delete');
            }
        }
        
        // --- MODAL UTILS (Ensure Defined) ---
        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }


        async function openAddClassModal(id = null) {
            const form = document.querySelector('#add-class-modal form');
            const title = document.querySelector('#add-class-modal h2');
            
            // Populate Teachers Dropdown
            const teachers = await fetchAdminData('teachers') || [];
            const teacherSelect = document.getElementById('class-teacher-select');
            teacherSelect.innerHTML = '<option value="">-- No Class Teacher --</option>' + 
                teachers.map(t => `<option value="${t.id}">${t.name}</option>`).join('');

            form.reset();
            form.id.value = ""; // Clear hidden ID by default

            if(id) {
                // Edit Mode
                const classes = await fetchAdminData('classes');
                const cls = classes.find(c => c.id === id);
                if(cls) {
                    form.id.value = cls.id;
                    form.name.value = cls.name;
                    form.level.value = cls.level;
                    form.class_teacher_id.value = cls.class_teacher_id || "";
                    form.active.value = cls.active !== false; // Handle boolean/string
                    if(title) title.innerText = "Edit Class";
                }
            } else {
                // New Mode
                if(title) title.innerText = "New Class";
            }
            
            document.getElementById('add-class-modal').classList.remove('hidden');
        }


        async function handleAddClass(e) {
            e.preventDefault();
            const form = e.target;
            const data = {
                id: form.id.value,
                name: form.name.value,
                level: form.level.value,
                class_teacher_id: form.class_teacher_id.value,
                active: form.active.value
            };
            
            const result = await fetchAdminData('add_class', data, 'POST');
            if(result && result.success) {
                alert('Class saved successfully');
                closeModal('add-class-modal');
                initDashboard(); 
                form.reset();
            } else {
                alert('Failed to save class');
            }
        }
        
        function openDeleteClassModal(id) {
            deleteTargetId = id;
            const modal = document.getElementById('delete-modal');
            modal.querySelector('h3').innerText = "Delete Class?";
            modal.querySelector('p').innerText = "Delete this class? This will NOT delete detailed student/teacher links yet."; 
            const btn = modal.querySelector('button.bg-red-500');
            btn.setAttribute('onclick', 'confirmDeleteClass()');
            modal.classList.remove('hidden');
        }
        
        async function confirmDeleteClass() {
             if(!deleteTargetId) return;
             const result = await fetchAdminData('delete_class', { id: deleteTargetId }, 'POST');
             if(result && result.success) { alert("Class deleted"); closeModal('delete-modal'); initDashboard(); }
        }

        // --- TEACHER HANDLERS ---
         async function openAddTeacherModal(id = null) {
            const modal = document.getElementById('add-teacher-modal');
            const form = modal.querySelector('form');
            const title = modal.querySelector('h2');
            
            form.reset();
            if(id) {
                const t = allTeachers.find(u => u.id == id);
                if(t) {
                    form.dataset.editId = t.id;
                    form.name.value = t.name;
                    form.email.value = t.email;
                    form.password.value = ""; 
                    form.password.placeholder = "Leave blank to keep same";
                    if(title) title.innerText = "Edit Teacher";
                }
            } else {
                 delete form.dataset.editId;
                 form.password.placeholder = "Password";
                 if(title) title.innerText = "Add New Teacher";
            }
            modal.classList.remove('hidden');
        }

        async function handleAddTeacher(e) {
            e.preventDefault();
            const form = e.target;
            const editId = form.dataset.editId;
            const data = {
                name: form.name.value,
                email: form.email.value,
                password: form.password.value
            };
            if(editId) data.id = editId;
            
            const result = await fetchAdminData('add_teacher', data, 'POST');
            if (result && result.success) {
                alert('Teacher saved successfully!');
                closeModal('add-teacher-modal');
                renderTeachers();
                initDashboard(); 
                form.reset();
            } else {
                 alert('Error: ' + (result?.message || 'Could not save teacher'));
            }
        }
        
        function openDeleteTeacherModal(id) {
            deleteTargetId = id;
            const modal = document.getElementById('delete-modal');
            modal.querySelector('h3').innerText = "Delete Teacher?";
            modal.querySelector('p').innerText = "Delete this teacher account?";
            const btn = modal.querySelector('button.bg-red-500');
            btn.setAttribute('onclick', 'confirmDeleteTeacher()');
            modal.classList.remove('hidden');
        }
        
         async function confirmDeleteTeacher() {
             if(!deleteTargetId) return;
             const result = await fetchAdminData('delete_teacher', { id: deleteTargetId }, 'POST');
             if(result && result.success) { 
                 alert("Teacher deleted"); 
                 closeModal('delete-modal'); 
                 renderTeachers(); // Refresh list
                 initDashboard();  // Refresh stats
             } else {
                 alert("Failed to delete");
             }
        }
        

        // --- SUBJECT ASSIGNMENT PANEL HANDLERS ---
        async function loadClassSubjects() {
            const classId = document.getElementById('assign-class-select').value;
            const container = document.getElementById('assignment-checkboxes');
            
            if(!classId) {
                container.innerHTML = '<p class="text-gray-400 text-sm italic text-center py-10">Select a class to configure subjects.</p>';
                return;
            }

            const classes = await fetchAdminData('classes');
            const cls = classes.find(c => c.id === classId);
            const subjects = await fetchAdminData('subjects') || [];
            
            // Filter by Level
            const levelSubjects = subjects.filter(s => s.level === cls.level);
            const assigned = cls.subjects || [];

            if(levelSubjects.length === 0) {
                 container.innerHTML = '<div class="text-center py-10 text-gray-400 italic">No subjects defined for this level yet.</div>';
            } else {
                 container.innerHTML = levelSubjects.map(s => {
                     const isChecked = assigned.includes(s.id);
                     return `
                        <label class="flex items-center gap-3 p-3 rounded-xl border border-gray-100 bg-white hover:border-gray-300 hover:bg-gray-50 cursor-pointer transition">
                            <input type="checkbox" name="assign_subject_ids" value="${s.id}" ${isChecked ? 'checked' : ''} class="w-5 h-5 rounded border-gray-300 text-secondary focus:ring-secondary">
                            <div>
                                <span class="block text-gray-800 font-bold text-sm">${s.name}</span>
                                <span class="block text-xs text-gray-400 font-mono">${s.code}</span>
                            </div>
                            <span class="ml-auto text-xs font-bold px-2 py-1 rounded bg-${s.active ? 'green' : 'red'}-100 text-${s.active ? 'green' : 'red'}-600">${s.active ? 'Active' : 'Inactive'}</span>
                        </label>
                     `;
                 }).join('');
            }
        }

        async function saveClassSubjects() {
             const classId = document.getElementById('assign-class-select').value;
             // Use specific container to avoid conflict if modal is open (unlikely but safe)
             const container = document.getElementById('assignment-checkboxes');
             const checkedBoxes = container.querySelectorAll('input[type="checkbox"]:checked');
             const subjectIds = Array.from(checkedBoxes).map(cb => cb.value);

             if(!classId) { alert('Please select a class first.'); return; }

             const result = await fetchAdminData('assign_class_subjects', { class_id: classId, subjects: subjectIds }, 'POST');
             if(result && result.success) {
                 alert('Class assignments saved!');
                 // Optionally refresh lists
                 renderClasses();
             } else {
                 alert('Failed to save assignments.');
             }
        }
        
        function toggleAllSubjects(check) {
            const container = document.getElementById('assignment-checkboxes');
            const checkboxes = container.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = check);
        }

        // --- MANAGE SUBJECTS MODAL (Legacy/Duplicate support) ---
        async function openManageSubjectsModal(classId) {
             const classes = await fetchAdminData('classes');
             const cls = classes.find(c => c.id === classId);
             if(!cls) return;

             const subjects = await fetchAdminData('subjects') || [];
             // Filter subjects by class level (e.g. only show Primary subjects for Primary class)
             const levelSubjects = subjects.filter(s => s.level === cls.level);
             
             const assigned = cls.subjects || [];

             const container = document.getElementById('class-subjects-list');
             document.querySelector('#manage-subjects-form input[name="class_id"]').value = classId;
             document.getElementById('manage-subjects-subtitle').innerText = `Configure subjects for ${cls.name} (${cls.level})`;

             if(levelSubjects.length === 0) {
                 container.innerHTML = '<div class="text-center py-10 text-gray-400 italic">No subjects defined for this level yet.</div>';
             } else {
                 container.innerHTML = levelSubjects.map(s => {
                     const isChecked = assigned.includes(s.id);
                     return `
                        <label class="flex items-center gap-3 p-3 rounded-xl border border-gray-100 hover:border-gray-300 hover:bg-gray-50 cursor-pointer transition">
                            <input type="checkbox" name="subject_ids" value="${s.id}" ${isChecked ? 'checked' : ''} class="w-5 h-5 rounded border-gray-300 text-secondary focus:ring-secondary">
                            <div>
                                <span class="block text-gray-800 font-bold text-sm">${s.name}</span>
                                <span class="block text-xs text-gray-400 font-mono">${s.code}</span>
                            </div>
                            <span class="ml-auto text-xs font-bold px-2 py-1 rounded bg-${s.active ? 'green' : 'red'}-100 text-${s.active ? 'green' : 'red'}-600">${s.active ? 'Active' : 'Inactive'}</span>
                        </label>
                     `;
                 }).join('');
             }

             document.getElementById('manage-subjects-modal').classList.remove('hidden');
        }

        async function handleSaveClassSubjects(e) {
            e.preventDefault();
            const form = e.target;
            const classId = form.class_id.value;
            
            // Get checked IDs
            const checkedBoxes = form.querySelectorAll('input[name="subject_ids"]:checked');
            const subjectIds = Array.from(checkedBoxes).map(cb => cb.value);

            const result = await fetchAdminData('assign_class_subjects', { class_id: classId, subjects: subjectIds }, 'POST');
            
            if(result && result.success) {
                alert('Subjects updated successfully');
                closeModal('manage-subjects-modal');
                renderClasses(); // Refresh counts
            } else {
                alert('Failed to update subjects');
            }
        }


        // --- VIEW RENDERERS ---
        async function renderClasses() {
            const grid = document.getElementById('class-grid');
            const classes = await fetchAdminData('classes');
            // Fetch teachers if not loaded
            if(allTeachers.length === 0) allTeachers = await fetchAdminData('teachers') || [];
            // Fetch students if not loaded (for counts)
            if(allStudents.length === 0) allStudents = await fetchAdminData('students') || [];
            allClasses = classes || [];
            
            if(!classes || classes.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-10 text-gray-400">No classes found. Add one to start.</div>';
                return;
            }

            // Group by Level
            const levels = ['KG', 'Primary', 'JHS'];
            let html = '';

            levels.forEach(level => {
                 const levelClasses = classes.filter(c => c.level === level);
                 if(levelClasses.length > 0) {
                     html += `
                        <div class="col-span-full mt-4 mb-2">
                            <h3 class="font-bold text-gray-500 uppercase text-xs tracking-wider border-b border-gray-100 pb-2">${level} Classes</h3>
                        </div>
                     ` + levelClasses.map(c => `
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition group relative">
                            <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition flex gap-2">
                                <button onclick="openManageSubjectsModal('${c.id}')" title="Manage Subjects" class="p-1 hover:bg-gray-100 rounded text-gray-400 hover:text-blue-500"><ion-icon name="book-outline"></ion-icon></button>
                                <button onclick="openAddClassModal('${c.id}')" class="p-1 hover:bg-gray-100 rounded text-gray-400 hover:text-accent"><ion-icon name="create-outline"></ion-icon></button>
                                <button onclick="confirmDeleteClass('${c.id}')" class="p-1 hover:bg-red-50 rounded text-gray-400 hover:text-red-500"><ion-icon name="trash-outline"></ion-icon></button>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-${getLevelColor(c.level)}-50 text-${getLevelColor(c.level)}-600 flex items-center justify-center text-2xl mb-4 relative">
                                <ion-icon name="people"></ion-icon>
                                ${c.active === false ? '<div class="absolute -top-1 -right-1 w-3 h-3 bg-gray-400 rounded-full border-2 border-white"></div>' : '<div class="absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></div>'}
                            </div>
                            <h3 class="font-bold text-gray-800 text-lg ${c.active === false ? 'opacity-50' : ''}">${c.name}</h3>
                            <p class="text-xs text-gray-400 font-bold uppercase mt-1 mb-2 text-${getLevelColor(c.level)}-500">${c.level || 'General'} <span class="ml-2 px-1.5 py-0.5 rounded text-[10px] ${c.active === false ? 'bg-gray-100 text-gray-500' : 'bg-green-50 text-green-600'}">${c.active === false ? 'INACTIVE' : 'ACTIVE'}</span></p>
                            
                            <p class="text-sm text-gray-600 mb-4 flex items-center gap-2">
                                <ion-icon name="person-outline"></ion-icon> 
                                ${c.class_teacher_id ? (allTeachers.find(t => t.id === c.class_teacher_id)?.name || 'Unknown Teacher') : '<span class="text-gray-400 italic">No Class Teacher</span>'}
                            </p>
                            
                            <div class="flex items-center justify-between text-sm text-gray-500 border-t border-gray-50 pt-3">
                                <div class="flex items-center gap-1" title="Assigned Subjects">
                                    <ion-icon name="book-outline"></ion-icon>
                                    <span>${c.subjects ? c.subjects.length : 0} Subjects</span>
                                </div>
                                <div class="flex items-center gap-1" title="Enrolled Students">
                                    <ion-icon name="people-circle-outline"></ion-icon>
                                    <span class="font-bold text-gray-700">${(allStudents || []).filter(s => s.class === c.name || s.class_id === c.id).length} Students</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                 }
            });
            
            // Catch-all
            const others = classes.filter(c => !levels.includes(c.level));
            if(others.length > 0) {
                 html += `
                    <div class="col-span-full mt-4 mb-2">
                            <h3 class="font-bold text-gray-500 uppercase text-xs tracking-wider border-b border-gray-100 pb-2">Other Classes</h3>
                        </div>
                 ` + others.map(c => `
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition group relative">
                             <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition flex gap-2">
                                <button onclick="openAddClassModal('${c.id}')" class="p-1 hover:bg-gray-100 rounded text-gray-400 hover:text-accent"><ion-icon name="create-outline"></ion-icon></button>
                                <button onclick="confirmDeleteClass('${c.id}')" class="p-1 hover:bg-red-50 rounded text-gray-400 hover:text-red-500"><ion-icon name="trash-outline"></ion-icon></button>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-gray-50 text-gray-600 flex items-center justify-center text-2xl mb-4">
                                <ion-icon name="people"></ion-icon>
                            </div>
                            <h3 class="font-bold text-gray-800 text-lg">${c.name}</h3>
                            <div class="flex items-center gap-4 text-sm text-gray-500 mt-4">
                                <div class="flex items-center gap-1">
                                    <ion-icon name="book-outline"></ion-icon>
                                    <span>${c.subjects ? c.subjects.length : 0} Subjects</span>
                                </div>
                            </div>
                        </div>
                 `).join('');
            }

            grid.innerHTML = html;
        }

        function getLevelColor(level) {
            if(level === 'KG') return 'pink'; 
            if(level === 'Primary') return 'blue';
            if(level === 'JHS') return 'purple';
            return 'gray';
        }

        async function renderTeachers() {
            const tbody = document.getElementById('teacher-table-body');
            const teachers = await fetchAdminData('teachers');
            allTeachers = teachers || [];
            
            tbody.innerHTML = (teachers||[]).map(t => `
                <tr class="hover:bg-gray-50/50 transition group">
                    <td class="px-6 py-4 font-mono text-xs text-gray-500">${t.id}</td>
                    <td class="px-6 py-4">
                        <div class="font-bold text-gray-800">${t.name}</div>
                        <div class="text-xs text-gray-400">${t.email}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex flex-wrap gap-1">
                             ${t.assigned_classes && t.assigned_classes.length > 0 ? t.assigned_classes.map(c => `<span class="px-2 py-1 bg-blue-50 text-blue-600 text-[10px] rounded font-mono font-bold">${c}</span>`).join('') : '<span class="text-xs text-gray-300 italic">No classes</span>'}
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition">
                             <button onclick="openAddTeacherModal('${t.id}')" class="text-gray-400 hover:text-accent transition p-1"><ion-icon name="create-outline"></ion-icon></button>
                             <button onclick="openDeleteTeacherModal('${t.id}')" class="text-gray-400 hover:text-red-500 transition p-1"><ion-icon name="trash-outline"></ion-icon></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        async function initSubjectView() {
            const tbody = document.getElementById('subject-table-body');
            const subjects = await fetchAdminData('subjects');
            
            allSubjects = subjects || [];
            
            // Group by Level
            const levels = ['KG', 'Primary', 'JHS'];
            let html = '';

            levels.forEach(level => {
                 const levelSubjects = allSubjects.filter(s => s.level === level);
                 if(levelSubjects.length > 0) {
                     html += `
                        <tr class="bg-gray-50/50"><td colspan="4" class="px-4 py-2 font-bold text-xs uppercase text-gray-400 tracking-wider sticky top-0 bg-gray-50">${level} Subjects</td></tr>
                     ` + levelSubjects.map(s => `
                        <tr class="hover:bg-gray-50/50 transition group border-b border-gray-50">
                            <td class="px-4 py-3 font-mono font-bold text-gray-600">${s.code}</td>
                            <td class="px-4 py-3 font-medium text-gray-800">${s.name}</td>
                            <td class="px-4 py-3"><span class="px-2 py-1 ${s.status === 'Active' ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-600'} text-[10px] rounded font-bold uppercase">${s.status}</span></td>
                            <td class="px-4 py-3 text-right">
                                <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition">
                                    <button onclick="openEditSubjectModal('${s.id}')" class="text-gray-400 hover:text-accent transition"><ion-icon name="create-outline"></ion-icon></button>
                                    <button onclick="deleteSubject('${s.id}')" class="text-gray-400 hover:text-red-500 transition"><ion-icon name="trash-outline"></ion-icon></button>
                                </div>
                            </td>
                        </tr>
                     `).join('');
                 }
            });

            // Catch-all for undefined levels
            const otherSubjects = allSubjects.filter(s => !levels.includes(s.level));
            if(otherSubjects.length > 0) {
                 html += `
                    <tr class="bg-gray-50/50"><td colspan="4" class="px-4 py-2 font-bold text-xs uppercase text-gray-400 tracking-wider">Other / Uncategorized</td></tr>
                 ` + otherSubjects.map(s => `
                    <tr class="hover:bg-gray-50/50 transition group border-b border-gray-50">
                        <td class="px-4 py-3 font-mono font-bold text-gray-600">${s.code}</td>
                        <td class="px-4 py-3 font-medium text-gray-800">${s.name}</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 ${s.status === 'Active' ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-600'} text-[10px] rounded font-bold uppercase">${s.status}</span></td>
                        <td class="px-4 py-3 text-right">
                            <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition">
                                <button onclick="openEditSubjectModal('${s.id}')" class="text-gray-400 hover:text-accent transition"><ion-icon name="create-outline"></ion-icon></button>
                                <button onclick="deleteSubject('${s.id}')" class="text-gray-400 hover:text-red-500 transition"><ion-icon name="trash-outline"></ion-icon></button>
                            </div>
                        </td>
                    </tr>
                 `).join('');
            }
            
            tbody.innerHTML = html;
            
            // Populate Class Assigmnent Select
            const clsSelect = document.getElementById('assign-class-select');
            // Assuming allClasses is populated
            if(allClasses.length === 0) allClasses = await fetchAdminData('classes');
            clsSelect.innerHTML = '<option value="">-- Select Class to Assign --</option>' + 
                 allClasses.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }

        async function saveClassSubjects() {
             const classId = document.getElementById('assign-class-select').value;
             if(!classId) return alert('Select a class first');
             
             // Get Checked checkboxes
             const checkboxes = document.querySelectorAll('input[name="subject_assign"]:checked');
             const subjectIds = Array.from(checkboxes).map(cb => cb.value);

             const result = await fetchAdminData('assign_class_subjects', { class_id: classId, subjects: subjectIds }, 'POST');
             if(result && result.success) alert('Assignments Saved');
        }

        function openEditStudentModal(id) {
             openAddStudentModal(id);
        }

        async function populateClassTeacherSelect(selectedId = null) {
            const select = document.getElementById('class-teacher-select');
            if(!select) return;
            
            if(allTeachers.length === 0) allTeachers = await fetchAdminData('teachers') || [];
            
            select.innerHTML = '<option value="">-- No Class Teacher --</option>' + 
                allTeachers.map(t => `<option value="${t.id}" ${t.id === selectedId ? 'selected' : ''}>${t.name}</option>`).join('');
        }

        async function openAddClassModal() {
            const form = document.querySelector('#add-class-modal form');
            form.reset();
            form.id.value = "";
            await populateClassTeacherSelect();
            document.querySelector('#add-class-modal h2').innerText = "New Class";
            document.getElementById('add-class-modal').classList.remove('hidden');
        }

        async function openEditClassModal(id) {
             const classes = await fetchAdminData('classes');
             const cls = classes.find(c => c.id === id);
             if(!cls) return;

             const form = document.querySelector('#add-class-modal form');
             form.id.value = cls.id;
             form.name.value = cls.name;
             if(form.level) form.level.value = cls.level;
             // handle active/inactive
             if(form.active) form.active.value = cls.active === false ? "false" : "true";
             
             await populateClassTeacherSelect(cls.class_teacher_id);
             
             document.querySelector('#add-class-modal h2').innerText = "Edit Class";
             document.getElementById('add-class-modal').classList.remove('hidden');
        }



        let allSubjects = [];

        function openAddSubjectModal() {
             const form = document.querySelector('#add-subject-modal form');
             form.reset();
             form.id.value = ""; // clear hidden id
             document.getElementById('subject-modal-title').innerText = "New Subject";
             document.getElementById('add-subject-modal').classList.remove('hidden');
        }

        async function openEditSubjectModal(id) {
            const subject = allSubjects.find(s => s.id === id);
            if(!subject) return;
            
            const form = document.querySelector('#add-subject-modal form');
            form.id.value = subject.id;
            form.name.value = subject.name;
            form.code.value = subject.code;
            form.status.value = subject.status;
            if(form.level) form.level.value = subject.level;

            document.getElementById('subject-modal-title').innerText = "Edit Subject";
            document.getElementById('add-subject-modal').classList.remove('hidden');
        }

        async function deleteSubject(id) {
            if(confirm('Delete this subject?')) {
                const result = await fetchAdminData('delete_subject', { id }, 'POST');
                if(result && result.success) {
                    initSubjectView();
                    initDashboard();
                }
            }
        }
        
        // Live Update System
        let liveUpdateInterval = null;

        function startLiveUpdates() {
            if(liveUpdateInterval) clearInterval(liveUpdateInterval);
            liveUpdateInterval = setInterval(async () => {
                // Only refresh if tab is visible to save resources
                if(document.hidden) return;

                console.log("Fetching live updates...");
                
                // 1. Refresh Stats
                await initDashboard(false); // Pass false to skip heavy re-renders if needed, or handle inside

                // 2. Refresh Active View Lists
                // Check which view is active and refresh its specific table
                if(!document.getElementById('view-dashboard').classList.contains('hidden')) {
                     // Dashboard view - stats already refreshed by initDashboard
                }
                else if(!document.getElementById('view-students').classList.contains('hidden')) {
                     await renderStudents();
                }
                else if(!document.getElementById('view-teachers').classList.contains('hidden')) {
                     await renderTeachers();
                }
                else if(!document.getElementById('view-classes').classList.contains('hidden')) {
                     await renderClasses();
                }
                else if(!document.getElementById('view-subjects').classList.contains('hidden')) {
                     await initSubjectView();
                }

            }, 5000); // 5 seconds interval
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
             initDashboard();
             startLiveUpdates();
        });

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function openAddYearModal() {
            alert('Feature coming soon');
        }

    </script>
</body>
</html>
